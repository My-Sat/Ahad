doctype html
html(lang="en")
  head
    meta(charset="utf-8")
    meta(name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no")
    title Dashboard

    // Bootstrap CSS (CDN)
    link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" crossorigin="anonymous")

    // Bootstrap Icons (for richer UI)
    link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css")

    // custom CSS (served from /public via express.static('public'))
    link(rel='stylesheet', href='/stylesheets/styles.css')

  body.app-bg
    // Top navigation / header
    header.bg-white.shadow-sm
      .container-fluid.p-2.d-flex.align-items-center.justify-content-between
        // Left: logo (link) + plain title to the right (not a link)
        .brand-wrap.d-flex.align-items-center.gap-2
          a(href='/' aria-label='Go to Ahad Printing Service home' class='d-inline-block')
            img.site-logo(src='/images/AHAD LOGO.png' alt='AHAD — Admin dashboard logo' width='64' height='64')
          .brand.d-flex.flex-column.justify-content-center
            span.brand-name AHADPRINT

        // Right: Large-screen pills nav + mobile utilities (nav moved to right)
        .d-flex.align-items-center.gap-2
          //- Only render desktop navigation & user menu when a user is logged in
          if currentUser
            - const role = (currentUser.role || '').toString().toLowerCase();
            - const perms = Array.isArray(currentUser.permissions) ? currentUser.permissions : [];
            - const hasAny = (arr) => arr.some(p => perms.includes(p));

            // Clerk “Orders” permissions (front desk)
            - const clerkRoutes = ['/orders/new','/orders/list','/orders/view/:orderId','/customers','/lookup','/search'];

            // Cashier “Payment” permissions
            - const cashierRoutes = ['/orders/pay','/orders/debtors','/orders/:orderId','/orders/:orderId/pay'];

            // What should appear in the Orders dropdown?
            // Default behavior is preserved:
            // - clerks see Orders (new) by default
            // - cashiers see Payment by default
            // Extra visibility comes from cross-assigned permissions.
            - const canSeeOrdersNew = (role === 'admin') || (role === 'clerk') || (role === 'cashier' && hasAny(clerkRoutes));
            - const canSeeOrdersPay = (role === 'admin') || (role === 'cashier') || (role === 'clerk' && hasAny(cashierRoutes));


            // Desktop nav
            nav#topTabs.nav.d-none.d-md-block
              ul.nav.nav-pills.mb-0.rounded-pill.shadow-sm(style='overflow:visible')
                if role === 'admin'
                  li.nav-item
                    a.nav-link.d-flex.align-items-center(href='/admin/services', data-ajax='true', role='tab', id='tab-services')
                      i.bi.bi-folder2-open.me-2(aria-hidden='true')
                      | Services
                      span.badge.bg-primary.ms-2#badge-services

                  li.nav-item
                    a.nav-link.d-flex.align-items-center(href='/admin/printers', data-ajax='true', role='tab', id='tab-printers')
                      i.bi.bi-printer.me-2(aria-hidden='true')
                      | Printers
                      span.badge.bg-secondary.ms-2#badge-printers

                  li.nav-item
                    a.nav-link.d-flex.align-items-center(href='/admin/stock', data-ajax='true', role='tab', id='tab-stock')
                      i.bi.bi-box-seam.me-2(aria-hidden='true')
                      | Stock
                      span.badge.bg-success.ms-2#badge-stock

                  li.nav-item
                    a.nav-link.d-flex.align-items-center(href='/admin/users', data-ajax='true', role='tab', id='tab-users')
                      i.bi.bi-people.me-2(aria-hidden='true')
                      | Users
                      span.badge.bg-info.ms-2#badge-users

                  li.nav-item
                    a.nav-link.d-flex.align-items-center(href='/admin/messaging', data-ajax='true', role='tab', id='tab-messaging')
                      i.bi.bi-chat-dots.me-2(aria-hidden='true')
                      | Messaging
                      span.badge.bg-warning.ms-2#badge-messaging

                  // Orders dropdown for admin (both entries)
                  li.nav-item.dropdown
                    a.nav-link.dropdown-toggle.d-flex.align-items-center(href='#', id='tab-orders', role='button', data-bs-toggle='dropdown', aria-expanded='false')
                      i.bi.bi-basket2.me-2(aria-hidden='true')
                      | Orders
                      span.badge.bg-dark.ms-2#badge-orders
                    ul.dropdown-menu
                      li
                        a.dropdown-item(href='/orders/new', data-ajax='true', id='tab-orders-new') Orders
                      li
                        a.dropdown-item(href='/orders/pay', data-ajax='true', id='tab-orders-pay') Payment

                  li.nav-item
                    a.nav-link.d-flex.align-items-center(href='/admin/reports', data-ajax='true', role='tab', id='tab-reports')
                      i.bi.bi-graph-up.me-2(aria-hidden='true')
                      | Reports

                else if role === 'cashier'
                  // Cashier: only Orders -> Payment
                  li.nav-item.dropdown
                    a.nav-link.dropdown-toggle.d-flex.align-items-center(href='#', id='tab-orders', role='button', data-bs-toggle='dropdown', aria-expanded='false')
                      i.bi.bi-basket2.me-2(aria-hidden='true')
                      | Orders
                    ul.dropdown-menu
                      if canSeeOrdersNew
                        li
                          a.dropdown-item(href='/orders/new', data-ajax='true', id='tab-orders-new') Orders
                      if canSeeOrdersPay
                        li
                          a.dropdown-item(href='/orders/pay', data-ajax='true', id='tab-orders-pay') Payment

                else if role === 'clerk'
                  // Clerk: only Orders -> Orders (front desk)
                  li.nav-item.dropdown
                    a.nav-link.dropdown-toggle.d-flex.align-items-center(href='#', id='tab-orders', role='button', data-bs-toggle='dropdown', aria-expanded='false')
                      i.bi.bi-basket2.me-2(aria-hidden='true')
                      | Orders
                    ul.dropdown-menu
                      if canSeeOrdersNew
                        li
                          a.dropdown-item(href='/orders/new', data-ajax='true', id='tab-orders-new') Orders
                      if canSeeOrdersPay
                        li
                          a.dropdown-item(href='/orders/pay', data-ajax='true', id='tab-orders-pay') Payment

            // Desktop user menu (show name + logout)
            .d-none.d-md-flex.align-items-center.gap-2
              .dropdown
                a.btn.btn-outline-secondary.dropdown-toggle(href='#' role='button' id='userMenu' data-bs-toggle='dropdown' aria-expanded='false')
                  i.bi.bi-person-circle.me-1
                  | #{currentUser.name || currentUser.username}
                ul.dropdown-menu.dropdown-menu-end(aria-labelledby='userMenu')
                  li
                    a.dropdown-item(href='/user-settings')
                      i.bi.bi-gear.me-2
                      | User Settings
                  li
                    a.dropdown-item(href='/logout') 
                      i.bi.bi-box-arrow-right.me-2
                      | Logout

          // Mobile / small-screen compact menu (keeps same links/ids but role-filtered)
          .d-md-none
            div.dropdown
              button.btn.btn-outline-secondary.btn-sm.dropdown-toggle(
                type='button',
                data-bs-toggle='dropdown',
                aria-expanded='false',
                aria-label='Open navigation menu'
              )
                i.bi.bi-list(aria-hidden='true')
              ul.dropdown-menu
                if currentUser
                  - const roleSm = (currentUser.role || '').toString().toLowerCase();
                  - const permsSm = Array.isArray(currentUser.permissions) ? currentUser.permissions : [];
                  - const hasAnySm = (arr) => arr.some(p => permsSm.includes(p));
                  - const clerkRoutesSm = ['/orders/new','/orders/list','/orders/view/:orderId','/customers','/lookup','/search'];
                  - const cashierRoutesSm = ['/orders/pay','/orders/debtors','/orders/:orderId','/orders/:orderId/pay'];
                  - const canSeeOrdersNewSm = (roleSm === 'admin') || (roleSm === 'clerk') || (roleSm === 'cashier' && hasAnySm(clerkRoutesSm));
                  - const canSeeOrdersPaySm = (roleSm === 'admin') || (roleSm === 'cashier') || (roleSm === 'clerk' && hasAnySm(cashierRoutesSm));

                  if roleSm === 'admin'
                    li
                      a.dropdown-item(href='/admin/services', data-ajax='true', id='tab-services-sm') Services
                    li
                      a.dropdown-item(href='/admin/printers', data-ajax='true', id='tab-printers-sm') Printers
                    li
                      a.dropdown-item(href='/admin/stock', data-ajax='true', id='tab-stock-sm') Stock
                    li
                      a.dropdown-item(href='/admin/users', data-ajax='true', id='tab-users-sm') Users
                    li
                      a.dropdown-item(href='/admin/messaging', data-ajax='true', id='tab-messaging-sm') Messaging
                    li
                      a.dropdown-item(href='/orders/new', data-ajax='true', id='tab-orders-new-sm') Orders — New
                    li
                      a.dropdown-item(href='/orders/pay', data-ajax='true', id='tab-orders-pay-sm') Orders — Pay
                    li
                      a.dropdown-item(href='/admin/reports', data-ajax='true', id='tab-reports-sm') Reports
                    li
                      hr.dropdown-divider
                    li
                      a.dropdown-item(href='/user-settings')
                        i.bi.bi-gear.me-2
                        | User Settings
                    li
                      a.dropdown-item(href='/logout')
                        i.bi.bi-box-arrow-right.me-2
                        | Logout

                  else if roleSm === 'cashier'
                    if canSeeOrdersNewSm
                      li
                        a.dropdown-item(href='/orders/new', data-ajax='true', id='tab-orders-new-sm') Orders — New
                    if canSeeOrdersPaySm
                      li
                        a.dropdown-item(href='/orders/pay', data-ajax='true', id='tab-orders-pay-sm') Payment
                    li
                      hr.dropdown-divider
                    li
                      a.dropdown-item(href='/logout')
                        i.bi.bi-box-arrow-right.me-2
                        | Logout

                  else if roleSm === 'clerk'
                    if canSeeOrdersNewSm
                      li
                        a.dropdown-item(href='/orders/new', data-ajax='true', id='tab-orders-new-sm') Orders — New
                    if canSeeOrdersPaySm
                      li
                        a.dropdown-item(href='/orders/pay', data-ajax='true', id='tab-orders-pay-sm') Orders — Pay
                    li
                      hr.dropdown-divider
                    li
                      a.dropdown-item(href='/logout')
                        i.bi.bi-box-arrow-right.me-2
                        | Logout

                else
                  li
                    a.dropdown-item(href='/login') Sign in

    // ... (rest of layout.pug unchanged) ...

    main.container.py-4#main-content
      block content

    div#assignToastWrapper(style="position: fixed; z-index: 1080; bottom: 1rem; right: 1rem;")
      .toast(role='alert' aria-live='assertive' aria-atomic='true' id='assignToast')
        .toast-header
          strong.me-auto.text-success Success
          small.text-muted.ms-2 Now
          button.btn-close.ms-2.mb-1(type='button', data-bs-dismiss='toast', aria-label='Close')
        .toast-body#assignToastBody
          | Price assigned successfully.

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous")
    script(src='/javascripts/toast.js')
    script(src='/javascripts/dashboard_nav.js')
    script(src='/javascripts/forms_spinner.js')
    script(src='/javascripts/edit_items.js')
    script(src='/javascripts/delete_modal.js')
    script(src='/javascripts/services_admin.js')
    script(src='/javascripts/printers.js')
    script(src='/javascripts/orders_client.js')


    block scripts
