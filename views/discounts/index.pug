extends ../layout

block content
  .container
    .d-none(data-main-width='wide')
    .row.justify-content-center
      .col-12.col-md-12
        .card.shadow-sm.dark-surface
          .card-body.dark-card-body
            .d-flex.justify-content-between.align-items-center.mb-3
              h4.mb-0.text-white Discounts Setup
              a.btn.btn-secondary.btn-sm(href='/orders/pay') Back to Pay

            p.text-muted-light.small Only ONE discount is applied per order (best match). Discount precedence:   service > service_category > customer_type > general.

            hr

            // General
            h6.text-white General Discount (applies to all orders)
            .row.g-2.mb-3
              .col-md-3
                select.form-select.form-select-sm.form-select-dark#generalMode
                  option(value='amount') Amount (GH₵)
                  option(value='percent') Percentage (%)
              .col-md-3
                input.form-control.form-control-sm.form-control-dark#generalValue(type='number', min='0', step='0.01', placeholder='Value')
              .col-md-3
                .form-check.mt-1
                  input.form-check-input#generalEnabled(type='checkbox', checked)
                  label.form-check-label(for='generalEnabled') Enabled

            hr

            // Customer Type
            h6.text-white Discount by Customer Type
            p.small.text-muted-light.mb-2 Add multiple rules (one per customer type). Duplicate targets are blocked.

            #custRulesContainer

            .d-flex.justify-content-end.mb-3
              button.btn.btn-outline-light-custom.btn-sm#addCustRule(type='button') + Add customer type rule

            // row template (hidden)
            template#custRuleTemplate
              .row.g-2.align-items-end.mb-2.discount-rule-row(data-scope='customer_type')
                .col-md-5
                  label.form-label.small.text-muted-light Customer type
                  select.form-select.form-select-sm.form-select-dark.rule-target
                    option(value='') -- Select --
                    each ct in customerTypes
                      option(value=ct)= ct
                .col-md-3
                  label.form-label.small.text-muted-light Mode
                  select.form-select.form-select-sm.form-select-dark.rule-mode
                    option(value='amount') Amount (GH₵)
                    option(value='percent') Percentage (%)
                .col-md-2
                  label.form-label.small.text-muted-light Value
                  input.form-control.form-control-sm.form-control-dark.rule-value(type='number', min='0', step='0.01')
                .col-md-1
                  .form-check.mt-4
                    input.form-check-input.rule-enabled(type='checkbox', checked)
                .col-md-1.text-end
                  button.btn.btn-sm.btn-outline-danger.rule-remove(type='button') ✕

            hr


            // Specific Customer
            h6.text-white Discount by Specific Customer
            p.small.text-muted-light.mb-2
              | Add multiple rules (one per customer). Search by name or phone, then pick the customer.

            #customerRulesContainer

            .d-flex.justify-content-end.mb-3
              button.btn.btn-outline-light-custom.btn-sm#addCustomerRule(type='button') + Add customer rule

            // template (hidden)
            template#customerRuleTemplate
              .row.g-2.align-items-end.mb-2.discount-rule-row(data-scope='customer')
                .col-md-2
                  label.form-label.small.text-muted-light Search by
                  select.form-select.form-select-sm.form-select-dark.customer-search-by
                    option(value='name') Name
                    option(value='phone') Phone
                .col-md-4
                  label.form-label.small.text-muted-light Search
                  input.form-control.form-control-sm.form-control-dark.customer-search-q(type='text', placeholder='Type to search...')
                .col-md-4
                  label.form-label.small.text-muted-light Customer
                  select.form-select.form-select-sm.form-select-dark.rule-target
                    option(value='') -- Select customer --
                .col-md-1
                  label.form-label.small.text-muted-light Mode
                  select.form-select.form-select-sm.form-select-dark.rule-mode
                    option(value='amount') Amount
                    option(value='percent') Percent
                .col-md-1
                  label.form-label.small.text-muted-light Value
                  input.form-control.form-control-sm.form-control-dark.rule-value(type='number', min='0', step='0.01')
                .col-md-1
                  .form-check.mt-4
                    input.form-check-input.rule-enabled(type='checkbox', checked)
                .col-md-1.text-end
                  button.btn.btn-sm.btn-outline-danger.rule-remove(type='button') ✕
            hr

            // Service Type
            h6.text-white Discount by Service
            p.small.text-muted-light.mb-2 Add multiple rules (one per service). Duplicate targets are blocked.

            #svcRulesContainer

            .d-flex.justify-content-end.mb-3
              button.btn.btn-outline-light-custom.btn-sm#addSvcRule(type='button') + Add service rule

            template#svcRuleTemplate
              .row.g-2.align-items-end.mb-2.discount-rule-row(data-scope='service')
                .col-md-5
                  label.form-label.small.text-muted-light Service
                  select.form-select.form-select-sm.form-select-dark.rule-target
                    option(value='') -- Select --
                    each s in services
                      option(value=String(s._id))= s.name
                .col-md-3
                  label.form-label.small.text-muted-light Mode
                  select.form-select.form-select-sm.form-select-dark.rule-mode
                    option(value='amount') Amount (GH₵)
                    option(value='percent') Percentage (%)
                .col-md-2
                  label.form-label.small.text-muted-light Value
                  input.form-control.form-control-sm.form-control-dark.rule-value(type='number', min='0', step='0.01')
                .col-md-1
                  .form-check.mt-4
                    input.form-check-input.rule-enabled(type='checkbox', checked)
                .col-md-1.text-end
                  button.btn.btn-sm.btn-outline-danger.rule-remove(type='button') ✕

            hr

            // Service Category
            h6.text-white Discount by Service Category
            p.small.text-muted-light.mb-2 Add multiple rules (one per category). Duplicate targets are blocked.

            #catRulesContainer

            .d-flex.justify-content-end.mb-3
              button.btn.btn-outline-light-custom.btn-sm#addCatRule(type='button') + Add category rule

            template#catRuleTemplate
              .row.g-2.align-items-end.mb-2.discount-rule-row(data-scope='service_category')
                .col-md-5
                  label.form-label.small.text-muted-light Category
                  select.form-select.form-select-sm.form-select-dark.rule-target
                    option(value='') -- Select --
                    each c in categories
                      option(value=String(c._id))= c.name
                .col-md-3
                  label.form-label.small.text-muted-light Mode
                  select.form-select.form-select-sm.form-select-dark.rule-mode
                    option(value='amount') Amount (GH₵)
                    option(value='percent') Percentage (%)
                .col-md-2
                  label.form-label.small.text-muted-light Value
                  input.form-control.form-control-sm.form-control-dark.rule-value(type='number', min='0', step='0.01')
                .col-md-1
                  .form-check.mt-4
                    input.form-check-input.rule-enabled(type='checkbox', checked)
                .col-md-1.text-end
                  button.btn.btn-sm.btn-outline-danger.rule-remove(type='button') ✕

            hr

            .d-flex.justify-content-end.gap-2
              button.btn.btn-outline-light-custom#loadDiscounts(type='button') Reload
              button.btn.btn-primary#saveDiscounts(type='button') Save

            p.small.text-muted-light.mt-2#discountSaveStatus

  // Keep Discounts page scripts inside #main-content so dashboard_nav AJAX loads them
  script(src='/javascripts/discounts.js')
