extends ../layout

block content
  // Page header
  .d-flex.justify-content-between.align-items-center.mb-4
    .d-flex.flex-column
      h3.mb-0 Services
      small.text-muted Manage services, units and pricing rules from one place

  .row.g-4
    // Left column — Categories selector + Services list + inline add service form
    .col-12.col-lg-7
      .card.h-100.dark-surface
        .card-body.dark-card-body
          .d-flex.justify-content-between.align-items-center.mb-3
            h5.card-title.mb-0 Services
            small.text-muted Choose a service to view details or add a new one below.

          // --- Category selector row ---
          .row.g-2.mb-3.align-items-center
            .col-auto
              label.form-label.small.mb-0(for='serviceCategorySelect') Service Category
            .col
              .input-group
                select.form-select.form-select-dark(id='serviceCategorySelect', name='serviceCategorySelect')
                  option(value='') -- All categories --
                button.btn.btn-outline-light-custom(type='button', id='newCategoryBtn', title='New category')
                  i.bi.bi-plus-lg.me-1
                  | New
                button.btn.btn-outline-light-custom(type='button', id='editCategoryBtn', title='Edit selected category')
                  i.bi.bi-pencil.me-1
                  | Edit
                // optional: remove category (admins only)
                button.btn.btn-outline-danger(type='button', id='deleteCategoryBtn', title='Delete selected category')
                  i.bi.bi-trash.me-1
                  | Delete

          // Add Service inline form (uses Bootstrap validation)
          // NOTE: category is implicit via the selected category; we add a hidden categoryId input
          form#add-service-form.needs-validation(method='post', action='/admin/services', class='row g-2 align-items-center mb-3', novalidate)
            input(type='hidden', name='categoryId', id='addServiceCategoryId', value='')
            .col-md-8
              input.form-control(type='text', name='name', id='addServiceName', placeholder='New service name (e.g., Printing)', required, autofocus)
              .invalid-feedback Please provide a service name.
            .col-md-4.col-auto
              button.btn.btn-primary(type='submit', id='addServiceBtn')
                span.spinner-border.spinner-border-sm.me-2(role='status', aria-hidden='true', style='display:none;', id='addServiceSpinner')
                | Add Service

          // inline success message (hidden by JS when using AJAX)
          .mt-2
            .alert.alert-success.role-alert#addServiceSuccess(style='display:none;')
              strong Added —
              span#addServiceSuccessText

          // Services table (existing UI) - will be replaced/filtered when a category is selected
          if services && services.length
            table.table.table-hover.table-borderless.mb-0
              thead
                tr
                  th Name
                  th.text-end Actions
              tbody#services-tbody
                each svc in services
                  // attach category id (if present) as a data attribute if backend includes it in services
                  tr(data-id=svc._id data-category=(svc.category ? svc.category : ''))
                    td
                      a.service-link(href=`/admin/services/${svc._id}`)= svc.name
                    td.text-end
                      // Bootstrap dropdown (using bootstrap icon)
                      .dropdown.d-inline-block
                        button.btn.btn-sm.btn-outline-light-custom.dropdown-toggle(type='button', id=`serviceMenuBtn-${svc._id}`, data-bs-toggle='dropdown', aria-expanded='false', aria-haspopup='true', title='Actions')
                          span.visually-hidden Actions
                        ul.dropdown-menu.dropdown-menu-end(aria-labelledby=`serviceMenuBtn-${svc._id}`)
                          li
                            button.dropdown-item.edit-service-btn(type='button', data-service-id=svc._id, data-service-name=svc.name)
                              i(class='bi bi-pencil me-2', aria-hidden='true')
                              | Edit
                          li
                            button.dropdown-item.open-delete-modal(type='button', data-action=`/admin/services/${svc._id}?_method=DELETE`, data-item-type='Service', data-item-name=svc.name)
                              i(class='bi bi-trash me-2', aria-hidden='true')
                              | Delete
          else
            .alert.alert-info.mb-0 No services yet. Use the form above to add the first service.

    // Right column — Units and Sub-units manager (accordion) (unchanged)
    .col-12.col-lg-5
      .card.h-100.dark-surface
        .card-body.dark-card-body
          h5.card-title.mb-3 Units & Sub-units
          // Add Unit form (Bootstrap validation)
          form#add-unit-form.needs-validation(method='post', action='/admin/units', class='row g-2 align-items-center mb-3', novalidate)
            .col
              input.form-control(type='text', name='name', id='addUnitName', placeholder='New unit name (e.g., Paper Size)', required)
              .invalid-feedback Please provide a unit name.
            .col-auto
              button.btn.btn-primary(type='submit', id='addUnitBtn')
                span.spinner-border.spinner-border-sm.me-2(role='status', aria-hidden='true', style='display:none;', id='addUnitSpinner')
                | Add Unit

          hr

          if units && units.length
            // Bootstrap accordion for compact unit list
            #unitsAccordion.accordion
              each u, idx in units
                - const panelId = `unitPanel-${idx}`
                .accordion-item
                  h2.accordion-header(id=`heading-${panelId}`)
                    button.accordion-button.collapsed(type='button', data-bs-toggle='collapse', data-bs-target=`#collapse-${panelId}`, aria-expanded='false', aria-controls=`collapse-${panelId}`)
                      .d-flex.justify-content-between.w-100
                        span.unit-name= u.name
                        small.text-muted.ms-2 #{ subunits ? subunits.filter(s => String(s.unit) === String(u._id)).length : 0 } sub-units

                  .accordion-collapse.collapse(id=`collapse-${panelId}`, aria-labelledby=`heading-${panelId}`)
                    .accordion-body
                      - const ush = subunits ? subunits.filter(s => String(s.unit) === String(u._id)) : []
                      if ush.length
                        ul.list-group.mb-3
                          each su in ush
                            li.list-group-item.d-flex.justify-content-between.align-items-center(data-subunit-id=su._id data-factor=(typeof su.factor !== 'undefined' && su.factor !== null) ? su.factor : 1)
                              span.subunit-name= su.name
                              .dropdown.d-inline-block
                                button.btn.btn-sm.btn-outline-light-custom.dropdown-toggle(type='button', id=`subMenuBtn-${su._id}`, data-bs-toggle='dropdown', aria-expanded='false', aria-haspopup='true', title='Actions')
                                  span.visually-hidden Actions
                                ul.dropdown-menu.dropdown-menu-end(aria-labelledby=`subMenuBtn-${su._id}`)
                                  li
                                    button.dropdown-item.edit-subunit-btn(type='button', data-unit-id=u._id, data-subunit-id=su._id, data-subunit-name=su.name)
                                      i(class='bi bi-pencil me-2', aria-hidden='true')
                                      | Edit
                                  li
                                    button.dropdown-item.open-delete-modal(type='button', data-action=`/admin/units/${u._id}/subunits/${su._id}?_method=DELETE`, data-item-type='Sub-unit', data-item-name=su.name)
                                      i(class='bi bi-trash me-2', aria-hidden='true')
                                      | Remove
                      else
                        p.text-muted.mb-3 No sub-units yet.

                      form.needs-validation(method='post', action=`/admin/units/${u._id}/subunits`, class='row g-2 align-items-center', novalidate)
                        .col
                          input.form-control(type='text', name='name', placeholder='New sub-unit name (e.g., A4)', required)
                          .invalid-feedback Please provide a sub-unit name.
                        .col-auto
                          input.form-control.form-control-sm(type='number', name='factor', min='1', step='1', value='1', title='Print factor (e.g., A4=1, A3=2)', style='width:110px;', placeholder='Factor')
                        .col-auto
                          button.btn.btn-sm.btn-outline-primary(type='submit')
                            span.spinner-border.spinner-border-sm.me-2(role='status', aria-hidden='true', style='display:none;')
                            | Add

                      .d-flex.justify-content-end.align-items-center.mt-3
                        .dropdown
                          button.btn.btn-sm.btn-outline-light-custom.dropdown-toggle(type='button', id=`unitMenuBtn-${u._id}`, data-bs-toggle='dropdown', aria-expanded='false', aria-haspopup='true', title='Unit actions')
                            span.visually-hidden Actions
                          ul.dropdown-menu.dropdown-menu-end(aria-labelledby=`unitMenuBtn-${u._id}`)
                            li
                              button.dropdown-item.edit-unit-btn(type='button', data-unit-id=u._id, data-unit-name=u.name)
                                i(class='bi bi-pencil me-2', aria-hidden='true')
                                | Edit Unit
                            li
                              button.dropdown-item.open-delete-modal(type='button', data-action=`/admin/units/${u._id}?_method=DELETE`, data-item-type='Unit', data-item-name=u.name)
                                i(class='bi bi-trash me-2', aria-hidden='true')
                                | Delete Unit
          else
            .alert.alert-light No units created yet. Use the form above to add the first unit.

  // Delete Confirmation Modal (shared)
  .modal.fade(id='deleteConfirmModal', tabindex='-1', aria-labelledby='deleteConfirmModalLabel', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='deleteConfirmModalLabel') Confirm delete
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          p#deleteConfirmMessage Are you sure you want to delete this item?
          p.text-muted.small.mt-2 Deleting cannot be undone.
        .modal-footer
          button.btn.btn-outline-light-custom(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-danger(type='button', id='confirmDeleteBtn') Yes, delete

  // Hidden delete form used by modal
  form#hiddenDeleteForm(method='post', action='', style='display:none;')
    input(type='hidden', name='_method', value='DELETE')

  // Edit Modals (Service, Unit, Sub-unit) — required for edit_items.js (unchanged)
  // Edit Service Modal
  .modal.fade(id='editServiceModal', tabindex='-1', aria-labelledby='editServiceModalLabel', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='editServiceModalLabel') Edit Service
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          form#editServiceForm
            input(type='hidden', id='editServiceId', name='id')
            .mb-3
              label.form-label(for='editServiceName') Service Name
              input.form-control(type='text', id='editServiceName', name='name', required)
        .modal-footer
          button.btn.btn-outline-light-custom(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary(type='button', id='saveEditServiceBtn') Save changes

  // Edit Unit Modal
  .modal.fade(id='editUnitModal', tabindex='-1', aria-labelledby='editUnitModalLabel', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='editUnitModalLabel') Edit Unit
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          form#editUnitForm
            input(type='hidden', id='editUnitId', name='id')
            .mb-3
              label.form-label(for='editUnitName') Unit Name
              input.form-control(type='text', id='editUnitName', name='name', required)
        .modal-footer
          button.btn.btn-outline-light-custom(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary(type='button', id='saveEditUnitBtn') Save changes

  // Edit Sub-unit Modal
  .modal.fade(id='editSubunitModal', tabindex='-1', aria-labelledby='editSubunitModalLabel', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='editSubunitModalLabel') Edit Sub-unit
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          form#editSubunitForm
            input(type='hidden', id='editSubunitUnitId', name='unitId')
            input(type='hidden', id='editSubunitId', name='id')
            .mb-3
              label.form-label(for='editSubunitName') Sub-unit Name
              input.form-control(type='text', id='editSubunitName', name='name', required)
            .mb-3
              label.form-label(for='editSubunitFactor') Print Factor
              input.form-control(type='number', id='editSubunitFactor', name='factor', min='1', step='1', value='1')
        .modal-footer
          button.btn.btn-outline-light-custom(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary(type='button', id='saveEditSubunitBtn') Save changes

  // --- Category create/edit modal ---
  .modal.fade(id='categoryModal', tabindex='-1', aria-labelledby='categoryModalLabel', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='categoryModalLabel') Service Category
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          form#categoryForm
            input(type='hidden', id='categoryId', name='id')
            .mb-3
              label.form-label(for='categoryName') Name
              input.form-control(type='text', id='categoryName', name='name', required)
            .mb-3
              .form-check
                input.form-check-input(type='checkbox', id='categoryShowInOrders', name='showInOrders')
                label.form-check-label(for='categoryShowInOrders') Show services in Orders (visible to admins and in orders/new)
        .modal-footer
          button.btn.btn-outline-light-custom(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary(type='button', id='saveCategoryBtn') Save

  // Toast (used for small success messages)
  .position-fixed(bottom='1rem', end='1rem', style='z-index:1080')
    .toast.fade(id='assignToast', role='status', aria-live='polite', aria-atomic='true')
      .toast-header
        strong.me-auto Success
        small.text-muted.ms-2.nowrap Ready
        button.btn-close.ms-2(type='button', data-bs-dismiss='toast', aria-label='Close')
      .toast-body#assignToastBody Saved.

  // small footer note
  .mt-3.text-muted

block append scripts
  script.
    (function () {
      'use strict';

      // --- Categories helper (AJAX-backed but tolerant) ---
      const serviceCategorySelect = document.getElementById('serviceCategorySelect');
      const newCategoryBtn = document.getElementById('newCategoryBtn');
      const editCategoryBtn = document.getElementById('editCategoryBtn');
      const deleteCategoryBtn = document.getElementById('deleteCategoryBtn');
      const categoryModalEl = document.getElementById('categoryModal');
      const categoryForm = document.getElementById('categoryForm');
      const categoryIdEl = document.getElementById('categoryId');
      const categoryNameEl = document.getElementById('categoryName');
      const categoryShowInOrdersEl = document.getElementById('categoryShowInOrders');
      const saveCategoryBtn = document.getElementById('saveCategoryBtn');
      const bootstrapCategoryModal = (window.bootstrap && categoryModalEl) ? new bootstrap.Modal(categoryModalEl) : null;
      const servicesTbody = document.getElementById('services-tbody');
      const addServiceCategoryIdEl = document.getElementById('addServiceCategoryId');
      const addServiceForm = document.getElementById('add-service-form');

      async function loadCategories() {
        if (!serviceCategorySelect) return;
        try {
          const res = await fetch('/admin/service-categories', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (!res.ok) throw new Error('no categories');
          const j = await res.json().catch(()=>null);
          const cats = (j && Array.isArray(j.categories)) ? j.categories : [];
          // populate the category select
          serviceCategorySelect.innerHTML = '<option value="">-- All categories --</option>';
          cats.forEach(c => {
            const o = document.createElement('option');
            o.value = c._id;
            o.textContent = c.name + (c.showInOrders ? '' : ' (hidden)');
            serviceCategorySelect.appendChild(o);
          });
        } catch (err) {
          // fail silently — page still operates
          console.warn('Unable to load categories', err);
        }
      }

      // show New Category modal
      if (newCategoryBtn) {
        newCategoryBtn.addEventListener('click', function () {
          if (categoryIdEl) categoryIdEl.value = '';
          if (categoryNameEl) categoryNameEl.value = '';
          if (categoryShowInOrdersEl) categoryShowInOrdersEl.checked = true;
          if (bootstrapCategoryModal) bootstrapCategoryModal.show();
        });
      }

      // edit selected category
      if (editCategoryBtn) {
        editCategoryBtn.addEventListener('click', function () {
          const id = serviceCategorySelect ? serviceCategorySelect.value : '';
          if (!id) { alert('Select a category to edit'); return; }
          // try to fetch details
          fetch(`/admin/service-categories/${encodeURIComponent(id)}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(r => r.ok ? r.json().catch(()=>null) : null)
            .then(j => {
              if (j && j.category) {
                const c = j.category;
                if (categoryIdEl) categoryIdEl.value = c._id;
                if (categoryNameEl) categoryNameEl.value = c.name || '';
                if (categoryShowInOrdersEl) categoryShowInOrdersEl.checked = !!c.showInOrders;
                if (bootstrapCategoryModal) bootstrapCategoryModal.show();
              } else {
                // fallback - just open modal for manual edit
                if (categoryIdEl) categoryIdEl.value = id;
                if (categoryNameEl) categoryNameEl.value = '';
                if (categoryShowInOrdersEl) categoryShowInOrdersEl.checked = true;
                if (bootstrapCategoryModal) bootstrapCategoryModal.show();
              }
            }).catch(()=> {
              if (categoryIdEl) categoryIdEl.value = id;
              if (categoryNameEl) categoryNameEl.value = '';
              if (categoryShowInOrdersEl) categoryShowInOrdersEl.checked = true;
              if (bootstrapCategoryModal) bootstrapCategoryModal.show();
            });
        });
      }

      // delete selected category (confirm)
      if (deleteCategoryBtn) {
        deleteCategoryBtn.addEventListener('click', function () {
          const id = serviceCategorySelect ? serviceCategorySelect.value : '';
          if (!id) { alert('Select a category to delete'); return; }
          if (!confirm('Delete this category? Services in it will not be removed.')) return;
          fetch(`/admin/service-categories/${encodeURIComponent(id)}`, {
            method: 'DELETE',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          }).then(r => {
            if (!r.ok) return r.text().then(t => { throw new Error(t || 'Failed'); });
            loadCategories();
            // clear category selection
            if (serviceCategorySelect) serviceCategorySelect.value = '';
            // show all services
            const rows = servicesTbody ? servicesTbody.querySelectorAll('tr') : [];
            rows.forEach(r => r.style.display = '');
            if (addServiceCategoryIdEl) addServiceCategoryIdEl.value = '';
          }).catch(err => { console.warn('Failed to delete category', err); alert('Failed to delete category'); });
        });
      }

      // Save category (create or update)
      if (saveCategoryBtn) {
        saveCategoryBtn.addEventListener('click', async function () {
          const id = categoryIdEl ? (categoryIdEl.value || '') : '';
          const name = categoryNameEl ? (categoryNameEl.value || '').trim() : '';
          const showInOrders = categoryShowInOrdersEl ? !!categoryShowInOrdersEl.checked : true;
          if (!name) { if (categoryNameEl) categoryNameEl.classList.add('is-invalid'); return; }
          saveCategoryBtn.disabled = true;
          try {
            const payload = { name, showInOrders: showInOrders ? '1' : '0' };
            const url = id ? `/admin/service-categories/${encodeURIComponent(id)}` : '/admin/service-categories';
            const method = id ? 'PUT' : 'POST';
            const res = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8', 'X-Requested-With': 'XMLHttpRequest' },
              body: new URLSearchParams(payload).toString()
            });
            if (!res.ok) {
              const j = await res.json().catch(()=>null);
              alert((j && j.error) ? j.error : 'Failed to save category');
              return;
            }
            await loadCategories();
            if (bootstrapCategoryModal) bootstrapCategoryModal.hide();
          } catch (err) {
            console.error('save category err', err);
            alert('Failed to save category (network)');
          } finally { saveCategoryBtn.disabled = false; }
        });
      }

      // When category changes, filter services table to match category AND set hidden category input used by add-service form.
      if (serviceCategorySelect) {
        serviceCategorySelect.addEventListener('change', function () {
          const id = this.value;
          // set hidden input so new services are created under selected category
          if (addServiceCategoryIdEl) addServiceCategoryIdEl.value = id || '';

          // If backend exposes endpoint to list services for a category, try it first.
          if (!id) {
            // show all rows
            const rows = servicesTbody ? servicesTbody.querySelectorAll('tr') : [];
            rows.forEach(r => r.style.display = '');
            return;
          }
          // Try AJAX: GET /admin/service-categories/:id/services (fallback to filtering by data-category attr)
          fetch(`/admin/service-categories/${encodeURIComponent(id)}/services`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(r => {
              if (!r.ok) throw new Error('no endpoint');
              return r.json().catch(()=>null);
            })
            .then(j => {
              if (j && Array.isArray(j.services)) {
                // replace services table body with returned services (minimally)
                if (!servicesTbody) return;
                servicesTbody.innerHTML = '';
                j.services.forEach(svc => {
                  const tr = document.createElement('tr');
                  tr.dataset.id = svc._id;
                  if (svc.category) tr.dataset.category = svc.category;
                  tr.innerHTML = `
                    <td><a class="service-link" href="/admin/services/${encodeURIComponent(svc._id)}">${escapeHtml(svc.name)}</a></td>
                    <td class="text-end">
                      <div class="dropdown d-inline-block">
                        <button class="btn btn-sm btn-outline-light-custom dropdown-toggle" type="button" data-bs-toggle="dropdown">Actions</button>
                        <ul class="dropdown-menu dropdown-menu-end">
                          <li><button class="dropdown-item edit-service-btn" data-service-id="${escapeHtml(svc._id)}" data-service-name="${escapeHtml(svc.name)}">Edit</button></li>
                          <li><button class="dropdown-item open-delete-modal" data-action="/admin/services/${escapeHtml(svc._id)}?_method=DELETE" data-item-type="Service" data-item-name="${escapeHtml(svc.name)}">Delete</button></li>
                        </ul>
                      </div>
                    </td>`;
                  servicesTbody.appendChild(tr);
                });
                return;
              }
              throw new Error('no services returned');
            })
            .catch(() => {
              // fallback: simple DOM filter using data-category attribute (no server support needed)
              const rows = servicesTbody ? servicesTbody.querySelectorAll('tr') : [];
              rows.forEach(r => {
                const cat = r.dataset.category || '';
                r.style.display = (cat && String(cat) === String(id)) ? '' : 'none';
              });
            });
        });
      }

      // Ensure add-service form includes selected categoryId when submitted (covers non-AJAX submission too)
      if (addServiceForm) {
        addServiceForm.addEventListener('submit', function (ev) {
          // category is already updated on change event, but ensure it is set just before submit
          const cat = serviceCategorySelect ? serviceCategorySelect.value : '';
          if (addServiceCategoryIdEl) addServiceCategoryIdEl.value = cat || '';
          // leave default submission behavior (server accepts categoryId)
        });
      }

      // Escape helper used above
      function escapeHtml(s) {
        if (!s && s !== 0) return '';
        return String(s).replace(/[&<>"'`=\/]/g, function (c) { return '&#' + c.charCodeAt(0) + ';'; });
      }

      // initial load
      loadCategories();

    })();
