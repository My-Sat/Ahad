extends ../layout

block content
  .d-flex.justify-content-between.align-items-center.mb-3
    h2.mb-0.text-white Catalogue
    .d-flex.gap-2
      a.btn.btn-secondary(href='/admin/stock') Back to Stock
      a.btn.btn-secondary(href='/admin/services') Back to services

  hr
  p.text-muted-light.small.mb-3
    | Catalogue defines count-units (global). No stock is stored here. Stock exists per store.

  .card.mb-4.dark-surface
    .card-body.dark-card-body
      .table-responsive
        table.table.table-striped.table-hover.table-sm
          thead
            tr
              th.text-white Material
              th.text-center.text-muted-light Actions
          tbody
            if materials && materials.length
              each m in materials
                tr(data-id=m._id)
                  td
                    strong.text-white= m.name
                    if m.selections && m.selections.length
                      br
                      small.text-muted-light
                        - const labels = m.selections.map(s => (s.unit && s.unit.name ? s.unit.name + ': ' + (s.subUnit && s.subUnit.name ? s.subUnit.name : s.subUnit) : '')).filter(Boolean);
                        = labels.join(' + ')
                  td.text-center
                    button.btn.btn-sm.btn-outline-danger.delete-catalogue-btn(data-id=m._id type='button') Delete
            else
              tr
                td.text-muted(colspan='2') No catalogue items defined.

  // Create Catalogue
  .card.mb-4.dark-surface
    .card-body.dark-card-body
      h5.mb-3.text-white Create catalogue item (global)
      form#create-catalogue-form(class='row g-3' novalidate)
        .col-12.col-md-6
          label.form-label(for='cuName') Name
          input.form-control(type='text', id='cuName', placeholder='e.g. A3 STD paper' required)

        .col-12
          small.text-muted-light.mb-2 Select one sub-unit per unit to form the tracked selection set.

        .col-12
          .accordion#catalogueUnitsAccordion.dark-surface
            each unit in units
              - const uid = unit._id
              .accordion-item
                h2.accordion-header
                  button.accordion-button.collapsed(type='button', data-bs-toggle='collapse', data-bs-target=`#u-${uid}`, aria-expanded='false')
                    span.text-white #{unit.name}
                .accordion-collapse.collapse(id=`u-${uid}`)
                  .accordion-body
                    ul.list-group
                      each su in subunits.filter(s=>String(s.unit) === String(uid))
                        li.list-group-item
                          label.form-check
                            input.form-check-input.unit-sub-checkbox(data-unit=uid data-subunit=su._id type='checkbox')
                            |&nbsp;
                            span= su.name

        .col-12.text-end
          button.btn.btn-primary(type='button' id='createCatalogueBtn')
            span.spinner-border.spinner-border-sm.me-2(style='display:none;' id='createCatalogueSpinner')
            | Create

  // Delete confirm modal
  .modal.fade(id='deleteConfirmModal', tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content
        .modal-header
          h5.modal-title Confirm delete
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body
          p#deleteConfirmMessage Are you sure you want to delete this item?
          p.text-muted.small.mt-2 Deleting cannot be undone.
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-outline-danger(type='button', id='confirmDeleteBtn') Yes, delete

block append scripts
  script(src='/public/javascripts/catalogue.js')
