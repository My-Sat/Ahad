extends layout

block content
  .container
    .d-none(data-main-width='wide')
    .row.justify-content-center.align-items-center(style="min-height:72vh;")
      .col-12.col-md-6.col-lg-4
        .card.shadow-lg.dark-surface
          .card-body.p-4.dark-card-body
            .text-center.mb-3
              img(src='/images/AHAD LOGO.png', alt='Logo', style='max-height:56px;')
              h4.mt-3.mb-0.text-white Reset Password
            p.text-muted-light.small Enter the OTP sent to your phone and choose a new password.

            if error
              .alert.alert-danger.mt-3= error

            form#resetPasswordForm(method='post', action='/reset-password', novalidate)
              input(type='hidden', name='phone', value=(phone || ''))

              .mb-3
                label.form-label.text-muted-light(for='otp') OTP
                input#otp.form-control.form-control-dark(type='text', name='otp', placeholder='6-digit OTP', required)

              .mb-3
                label.form-label.text-muted-light(for='newPassword') New Password
                .password-field.position-relative
                  input#newPassword.form-control.form-control-dark(type='password', name='newPassword', required)
                  button.password-toggle(type='button', data-password-toggle, data-password-target='newPassword', aria-pressed='false', aria-label='Show password')
                    i.bi.bi-eye

              .mb-3
                label.form-label.text-muted-light(for='confirmPassword') Confirm Password
                .password-field.position-relative
                  input#confirmPassword.form-control.form-control-dark(type='password', name='confirmPassword', required)
                  button.password-toggle(type='button', data-password-toggle, data-password-target='confirmPassword', aria-pressed='false', aria-label='Show password')
                    i.bi.bi-eye
                small#resetPasswordMatch.text-muted-light.d-block.mt-1 Type the same password to confirm.

              button.btn.btn-primary.w-100(type='submit') Reset Password

            .text-center.mt-3
              a.small.text-muted(href='/forgot-password') Resend OTP
              |  Â· 
              a.small.text-muted(href='/login') Back to login

block scripts
  script.
    (function () {
      function initPasswordMatch(formId, pwId, confirmId, msgId) {
        const form = document.getElementById(formId);
        const pw = document.getElementById(pwId);
        const confirm = document.getElementById(confirmId);
        const msg = document.getElementById(msgId);
        if (!form || !pw || !confirm || !msg) return;

        const submitBtn = form.querySelector('button[type="submit"]');

        function setState(state, text) {
          msg.textContent = text;
          msg.classList.remove('text-muted-light', 'text-success', 'text-danger');
          msg.classList.add(state);
        }

        function update() {
          const a = pw.value || '';
          const b = confirm.value || '';
          if (!a && !b) {
            setState('text-muted-light', 'Type the same password to confirm.');
            if (submitBtn) submitBtn.disabled = false;
            return;
          }
          if (!a || !b) {
            setState('text-muted-light', 'Keep typing to confirm the password.');
            if (submitBtn) submitBtn.disabled = false;
            return;
          }
          if (a === b) {
            setState('text-success', 'Passwords match.');
            if (submitBtn) submitBtn.disabled = false;
          } else {
            setState('text-danger', 'Passwords do not match.');
            if (submitBtn) submitBtn.disabled = true;
          }
        }

        pw.addEventListener('input', update);
        confirm.addEventListener('input', update);
        form.addEventListener('submit', function (e) {
          if (pw.value !== confirm.value) {
            e.preventDefault();
            setState('text-danger', 'Passwords do not match.');
            confirm.focus();
          }
        });
        update();
      }

      initPasswordMatch('resetPasswordForm', 'newPassword', 'confirmPassword', 'resetPasswordMatch');
    })();
