extends ../layout

block content
  .container
    .d-none(data-main-width='wide')
    .d-flex.justify-content-between.align-items-center.mb-3
      h1.mb-0.text-white Users
      button.btn.btn-secondary#btnNewUser(type='button', data-bs-toggle='modal', data-bs-target='#modalNewUser')
        i.bi.bi-person-plus.me-2
        | New user

    // ---------------- FLASH AREA (fixed & robust) ----------------
    if flash
      if typeof flash === 'object'
        each msgs, type in flash
          each m in msgs
            // keep alerts unchanged so server flash styling remains predictable
            div(class='alert alert-' + type)= m
      else
        each m in flash
          div.alert.alert-info= m

    // ---------------- USERS TABLE ----------------
    .card.dark-surface
      .card-body.dark-card-body
        table.table.table-hover.table-striped.mt-3
          thead
            tr
              th Name
              th Username
              th Role
              th Permissions
              th.text-end Actions
          tbody
            each user in users
              tr
                td= user.name || '-'
                td= user.username
                td.text-capitalize= user.role
                td
                  if user.permissions && user.permissions.length
                    each p in user.permissions
                      span.badge.bg-info.me-1= p
                  else
                    span.text-muted None

                td.text-end
                  button.btn.btn-sm.btn-outline-secondary.me-2(onclick=`openPermissionsModal('${user._id}')`)
                    i.bi.bi-shield-lock-fill.me-1
                    | Permissions

                  // DELETE via POST + method override
                  button.btn.btn-sm.btn-outline-danger.open-user-delete(
                    type='button'
                    data-action=`/admin/users/${user._id}?_method=DELETE`
                    data-user-name=(user.name || user.username || 'this user')
                  )
                    i.bi.bi-trash.me-1
                    | Delete

  // ---------------- NEW USER MODAL ----------------
  .modal.fade#modalNewUser(tabindex='-1' aria-hidden='true')
    .modal-dialog
      .modal-content.dark-surface
        .modal-header
          h5.modal-title.text-white Create user
          button.btn-close(type='button', data-bs-dismiss='modal' aria-label='Close')

        form#newUserForm(action='/admin/users' method='POST')
          .modal-body.dark-card-body
            .mb-3
              label.form-label.text-muted-light Username
              input.form-control.form-control-dark(type='text' name='username' required)

            .mb-3
              label.form-label.text-muted-light Name
              input.form-control.form-control-dark(type='text' name='name')

            .mb-3
              label.form-label.text-muted-light Role
              select.form-select.form-select-dark(name='role' required)
                option(value='clerk' selected) Clerk
                option(value='cashier') Cashier
                option(value='admin') Admin

            .mb-3
              label.form-label.text-muted-light Password
              input#newUserPassword.form-control.form-control-dark(type='password' name='password' required)

            .mb-3
              label.form-label.text-muted-light Confirm password
              input#newUserPasswordConfirm.form-control.form-control-dark(type='password' name='passwordConfirm' required)
              small#newUserPasswordMatch.text-muted-light.d-block.mt-1 Type the same password to confirm.

            .mb-3
              label.form-label.text-muted-light Email
              input.form-control.form-control-dark(type='email' name='email')

            .mb-3
              label.form-label.text-muted-light Phone
              input.form-control.form-control-dark(type='text' name='phone' required)

          .modal-footer
            button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Close
            button.btn.btn-secondary(type='submit') Create

  // ---------------- PERMISSIONS MODAL ----------------
  .modal.fade#modalPermissions(tabindex='-1' aria-hidden='true')
    .modal-dialog
      .modal-content.dark-surface
        .modal-header
          h5.modal-title.text-white Manage permissions
          button.btn-close(type='button', data-bs-dismiss='modal' aria-label='Close')

        .modal-body.dark-card-body
          form#permissionsForm
            input(type='hidden' name='userId' id='permUserId')

            p.mb-2.text-muted-light Select routes this user should be allowed to access:

            // Known permission routes
            .form-check
              input.form-check-input(type='checkbox' id='perm_customer' value='/customers' name='permissions')
              label.form-check-label(for='perm_customer') Customer registration page

            .form-check
              input.form-check-input(type='checkbox' id='perm_orders_pay' value='/orders/pay' name='permissions')
              label.form-check-label(for='perm_orders_pay') Orders Payment page

            .form-check
              input.form-check-input(type='checkbox' id='perm_create_order' value='/orders/new' name='permissions')
              label.form-check-label(for='perm_create_order') View Order page

            .form-check
              input.form-check-input(type='checkbox' id='perm_view_order_details' value='/orders/view/:orderId' name='permissions')
              label.form-check-label(for='perm_view_order_details') View order details

            .form-check
              input.form-check-input(type='checkbox' id='perm_fetch_order_byID' value='/orders/:orderId' name='permissions')
              label.form-check-label(for='perm_fetch_order_byID') Fetch order by ID at payment page

            .form-check
              input.form-check-input(type='checkbox' id='perm_view_order_list' value='/orders/list' name='permissions')
              label.form-check-label(for='perm_view_order_list') View order list

            .form-check
              input.form-check-input(type='checkbox' id='perm_pay_order' value='/orders/:orderId/pay' name='permissions')
              label.form-check-label(for='perm_pay_order') Pay order

            .form-check
              input.form-check-input(type='checkbox' id='perm_fetch_customer' value='/lookup' name='permissions')
              label.form-check-label(for='perm_fetch_customer') Fetch existing customer at registration / front desk

            .form-check
              input.form-check-input(type='checkbox' id='perm_orders_debtors' value='/orders/debtors' name='permissions')
              label.form-check-label(for='perm_orders_debtors') Debtors page

            .form-check
              input.form-check-input(type='checkbox' id='perm_admin_services' value='/admin/services' name='permissions')
              label.form-check-label(for='perm_admin_services') Admin permissions (Admin services â€” use with care)

        .modal-footer
          button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Close
          button.btn.btn-primary#savePermissionsBtn(type='button') Save

  // ---------------- DELETE CONFIRM MODAL ----------------
  .modal.fade#modalDeleteUser(tabindex='-1' aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title.text-white Confirm delete
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          p#deleteUserMessage.text-muted-light Are you sure you want to delete this user?
          p.text-muted-light.small.mb-0 This action cannot be undone.
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-danger(type='button', id='confirmDeleteUserBtn') Yes, delete

  form#deleteUserForm(method='POST', action='', style='display:none;')

block scripts
  script(src='/javascripts/users_admin.js')
