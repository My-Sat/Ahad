extends ../layout

block content
  .container
    .d-none(data-main-width='wide')
    .row.justify-content-center
      .col-12.col-md-7.col-lg-5
        .card.shadow-sm.dark-surface
          .card-body.p-4.dark-card-body
            .text-center.mb-3
              img(src='/images/AHAD LOGO.png', alt='Logo', style='max-height:56px;')
              h4.mt-3.mb-0.text-white User Settings
            p.text-muted-light.small.mb-4 Change your password below.

            if error
              .alert.alert-danger= error

            form#userSettingsForm(method='post', action='/user-settings/password', novalidate)
              .mb-3
                label.form-label.text-muted-light(for='oldPassword') Old password
                input#oldPassword.form-control.form-control-dark(type='password', name='oldPassword', required)

              .mb-3
                label.form-label.text-muted-light(for='newPassword') New password
                input#newPassword.form-control.form-control-dark(type='password', name='newPassword', required)

              .mb-3
                label.form-label.text-muted-light(for='confirmPassword') Confirm new password
                input#confirmPassword.form-control.form-control-dark(type='password', name='confirmPassword', required)
                small#userSettingsPasswordMatch.text-muted-light.d-block.mt-1 Type the same password to confirm.

              button.btn.btn-primary.w-100(type='submit')
                i.bi.bi-check2-circle.me-2
                | Update Password

  // Success modal (shown after password update)
  if success
    .modal.fade#passwordSuccessModal(tabindex='-1' aria-labelledby='passwordSuccessModalLabel' aria-hidden='true')
      .modal-dialog.modal-dialog-centered
        .modal-content.dark-surface
          .modal-header
            h5.modal-title.text-white#passwordSuccessModalLabel Password Updated
            button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
          .modal-body.text-muted-light
            | Your password has been updated successfully. Redirecting...
          .modal-footer
            button.btn.btn-primary(type='button', data-bs-dismiss='modal') OK

block scripts
  script.
    (function () {
      function initPasswordMatch(formId, pwId, confirmId, msgId) {
        const form = document.getElementById(formId);
        const pw = document.getElementById(pwId);
        const confirm = document.getElementById(confirmId);
        const msg = document.getElementById(msgId);
        if (!form || !pw || !confirm || !msg) return;

        const submitBtn = form.querySelector('button[type="submit"]');

        function setState(state, text) {
          msg.textContent = text;
          msg.classList.remove('text-muted-light', 'text-success', 'text-danger');
          msg.classList.add(state);
        }

        function update() {
          const a = pw.value || '';
          const b = confirm.value || '';
          if (!a && !b) {
            setState('text-muted-light', 'Type the same password to confirm.');
            if (submitBtn) submitBtn.disabled = false;
            return;
          }
          if (!a || !b) {
            setState('text-muted-light', 'Keep typing to confirm the password.');
            if (submitBtn) submitBtn.disabled = false;
            return;
          }
          if (a === b) {
            setState('text-success', 'Passwords match.');
            if (submitBtn) submitBtn.disabled = false;
          } else {
            setState('text-danger', 'Passwords do not match.');
            if (submitBtn) submitBtn.disabled = true;
          }
        }

        pw.addEventListener('input', update);
        confirm.addEventListener('input', update);
        form.addEventListener('submit', function (e) {
          if (pw.value !== confirm.value) {
            e.preventDefault();
            setState('text-danger', 'Passwords do not match.');
            confirm.focus();
          }
        });
        update();
      }

      initPasswordMatch('userSettingsForm', 'newPassword', 'confirmPassword', 'userSettingsPasswordMatch');
    })();
  if success
    script.
      (function () {
        try {
          const modalEl = document.getElementById('passwordSuccessModal');
          if (!modalEl || !window.bootstrap) return;

          const m = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
          m.show();

          const redirectTo = "#{redirectTo || '/'}";

          // Auto-redirect shortly after showing
          setTimeout(function () {
            window.location.href = redirectTo;
          }, 1400);

          // If user closes modal, redirect immediately
          modalEl.addEventListener('hidden.bs.modal', function () {
            window.location.href = redirectTo;
          }, { once: true });
        } catch (e) {
          window.location.href = "#{redirectTo || '/'}";
        }
      })();
