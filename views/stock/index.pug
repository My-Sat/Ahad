extends ../layout

block content
  .d-none(data-main-width='wide')
  .d-flex.justify-content-between.align-items-center.mb-3
    h2.mb-0.text-white Stock Dashboard (Stores)
    .d-flex.gap-2
      a.btn.btn-secondary(href='/admin/catalogue') Catalogue
      a.btn.btn-secondary(href='/admin/services') Back to services

  hr

  // Store selector + create + operational
  .card.mb-3.dark-surface
    .card-body.dark-card-body

      // Operational store status (top of card)
      .d-flex.justify-content-end.mb-2
        if operationalStore
          .d-inline-flex.align-items-center.gap-2
            span.text-muted-dark OPERATIONAL STORE:
            span.badge.bg-info #{operationalStore.name}
        else
          span.badge.bg-warning.text-dark No operational store set

      .row.g-2.align-items-end
        .col-12.col-md-5
          label.form-label.text-muted-light(for='storeSelect') Select store
          select.form-select#storeSelect
            if stores && stores.length
              each s in stores
                option(value=s._id selected=(selectedStore && String(selectedStore._id)===String(s._id)) ? true : false)
                  | #{s.name}
            else
              option(value='') No stores yet

        .col-12.col-md-3
          .d-grid.gap-2
            button.btn.btn-primary(type='button', id='openCreateStoreBtn') Create Store
            button.btn.btn-outline-light-custom(
              type='button'
              id='openManageStoreBtn'
              disabled=(!selectedStore)
            )
              i.bi.bi-pencil-square.me-1
              | Manage Store

        .col-12.col-md-4.text-md-end
          button.btn.btn-outline-light-custom(type='button', id='setOperationalBtn' disabled=(!selectedStore)) Set Selected as Operational

  // Store stock table
  .card.mb-4.dark-surface
    .card-body.dark-card-body
      if !selectedStore
        p.text-muted-light.small No store selected. Create a store first.
      else
        .table-responsive
          table.table.table-striped.table-hover.table-sm
            thead
              tr
                th.text-white Stock item
                th.text-center.text-muted-light Stocked
                th.text-center.text-muted-light Used
                th.text-center.text-muted-light Remaining
                th.text-center.text-muted-light Actions
            tbody
              if stocks && stocks.length
                each ss in stocks
                  - const used = (typeof ss.used === 'number') ? ss.used : 0;
                  - const stocked = (typeof ss.stocked === 'number') ? ss.stocked : 0;
                  - const remaining = (typeof ss.remaining === 'number') ? ss.remaining : Math.max(0, stocked - used);
                  tr(data-stock-id=ss._id data-material-id=(ss.material && ss.material._id ? ss.material._id : '') data-stocked=stocked)
                    td
                      if ss.material
                        strong.text-white= ss.material.name
                        if ss.material.selections && ss.material.selections.length
                          br
                          small.text-muted-light
                            - const labels = ss.material.selections.map(s => {
                            -   const u = (s.unit && s.unit.name) ? s.unit.name : String(s.unit);
                            -   const su = (s.subUnit && s.subUnit.name) ? s.subUnit.name : String(s.subUnit);
                            -   return `${u}: ${su}`;
                            - });
                            = labels.join(' + ')
                      else
                        span.text-muted-light (missing material)
                    td.text-center.text-muted-light.stocked-cell= stocked
                    td.text-center.text-muted-light.used-cell= used
                    td.text-center.remaining-cell
                      if remaining < 0
                        span.text-danger #{remaining}
                      else
                        span #{remaining}
                    td.text-center.text-nowrap
                      .dropdown.d-inline-block
                        button.btn.btn-sm.btn-outline-light-custom(
                          type='button'
                          data-bs-toggle='dropdown'
                          aria-expanded='false'
                          title='Actions'
                        )
                          i.bi.bi-three-dots-vertical

                        ul.dropdown-menu.dropdown-menu-end
                          li
                            a.dropdown-item.adjust-stock-btn(href='#' data-stock-id=ss._id data-stocked=stocked)
                              i.bi.bi-sliders.me-2
                              | Adjust
                          li
                            a.dropdown-item.transfer-stock-btn(href='#' data-stock-id=ss._id)
                              i.bi.bi-arrow-left-right.me-2
                              | Transfer
                          li
                            a.dropdown-item.view-activity-btn(href='#' data-stock-id=ss._id)
                              i.bi.bi-clock-history.me-2
                              | View activity
                          li
                            hr.dropdown-divider
                          li
                            a.dropdown-item.text-danger.remove-stock-btn(href='#' data-stock-id=ss._id)
                              i.bi.bi-trash.me-2
                              | Remove
              else
                tr
                  td.text-muted(colspan='5') No stock items in this store.

  // Add catalogue to selected store
  .card.mb-4.dark-surface
    .card-body.dark-card-body
      h5.mb-3.text-white Add catalogue to store
      if !selectedStore
        p.text-muted-light.small Create/select a store first.
      else
        form#add-to-store-form(class='row g-3' novalidate data-store-id=(selectedStore ? selectedStore._id : ''))
          .col-12.col-md-7
            label.form-label.text-muted-light(for='catalogueSelect') Catalogue item
            select.form-select#catalogueSelect
              if catalogues && catalogues.length
                each c in catalogues
                  option(value=c._id)= c.name
              else
                option(value='') No catalogue items yet

          .col-12.col-md-3
            label.form-label.text-muted-light(for='initialStockInput') Stock Initial
            input.form-control#initialStockInput(type='number', value='0', min='0', step='1')

          .col-12.col-md-2.d-grid
            button.btn.btn-primary#addToStoreBtn(type='button')
              span.spinner-border.spinner-border-sm.me-2(style='display:none;' id='addToStoreSpinner')
              | Add

  // Create Store Modal
  .modal.fade(id='createStoreModal', tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title.text-white Create Store
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          label.form-label.text-muted-light(for='newStoreName') Store name
          input.form-control#newStoreName(type='text', placeholder='e.g. Main Store')
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary(type='button', id='createStoreBtn')
            span.spinner-border.spinner-border-sm.me-2(style='display:none;' id='createStoreSpinner')
            | Create

    // Manage Store Modal
  .modal.fade(id='manageStoreModal', tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title.text-white Manage Store
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          input(type='hidden', id='editStoreId')
          label.form-label.text-muted-light(for='editStoreName') Store name
          input.form-control#editStoreName(type='text', placeholder='e.g. Main Store')
          hr
          p.text-muted-light.small.mb-2 Danger zone
          button.btn.btn-outline-danger(type='button', id='openDeleteStoreBtn')
            i.bi.bi-trash.me-1
            | Delete this store
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary(type='button', id='saveStoreBtn')
            span.spinner-border.spinner-border-sm.me-2(style='display:none;' id='saveStoreSpinner')
            | Save changes

  // Delete Store Confirmation Modal
  .modal.fade(id='deleteStoreConfirmModal', tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content
        .modal-header
          h5.modal-title Confirm delete store
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body
          p#deleteStoreConfirmMessage Delete this store?
          p.text-muted.small.mb-0
            | This will permanently remove the store and clear its stock items + related logs.
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-danger(type='button', id='confirmDeleteStoreBtn') Yes, delete store
          


  // Adjust Modal
  .modal.fade(id='adjustStockModal', tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title.text-white Adjust stocked quantity
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          form
            input(type='hidden', id='adjustStockId')
            input(type='hidden', id='adjustCurrentStock')

            .mb-3
              label.form-label.text-muted-light Adjustment mode
              .form-check
                input.form-check-input(type='radio', name='adjustMode', id='adjustModeDelta', value='delta', checked)
                label.form-check-label(for='adjustModeDelta') Apply Delta ( +5 / -3 )
              .form-check
                input.form-check-input(type='radio', name='adjustMode', id='adjustModeAbsolute', value='absolute')
                label.form-check-label(for='adjustModeAbsolute') Set Absolute Value (resets Used)

            .mb-3
              label.form-label.text-muted-light(for='adjustStockInput') Value
              input.form-control#adjustStockInput(type='text', placeholder='+5 or -3 / 120', required)

        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary(type='button', id='saveAdjustStockBtn')
            span.spinner-border.spinner-border-sm.me-2(id='saveAdjustSpinner', style='display:none;')
            span#saveAdjustLabel Save

  // Transfer Modal
  .modal.fade(id='transferModal', tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title.text-white Transfer stock
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          input(type='hidden', id='transferStockId')
          .mb-3
            label.form-label.text-muted-light(for='transferToStore') To store
            select.form-select#transferToStore
              if stores && stores.length
                each s in stores
                  if !selectedStore || String(s._id) !== String(selectedStore._id)
                    option(value=s._id)= s.name
          .mb-3
            label.form-label.text-muted-light(for='transferQty') Quantity
            input.form-control#transferQty(type='number', min='1', step='1', value='1')

        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary(type='button', id='confirmTransferBtn')
            span.spinner-border.spinner-border-sm.me-2(id='transferSpinner', style='display:none;')
            | Transfer

  // Activity Modal
  .modal.fade(id='activityModal', tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered.modal-lg
      .modal-content.dark-surface
        .modal-header
          h5.modal-title.text-white Stock activity
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          div#activityMeta.text-muted-light.small.mb-2
          .table-responsive
            table.table.table-sm
              thead
                tr
                  th.text-muted-light Date
                  th.text-muted-light Action
                  th.text-muted-light Î”
                  th.text-muted-light Balance
                  th.text-muted-light Details
              tbody#activityTbody
                tr
                  td.text-muted(colspan='5') Select "View" to load activity.

  // Remove confirm modal
  .modal.fade(id='deleteConfirmModal', tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content
        .modal-header
          h5.modal-title Confirm remove
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body
          p#deleteConfirmMessage Remove this stock item from the store list?
          p.text-muted.small.mt-2 History remains; item can be re-added later.
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-danger(type='button', id='confirmDeleteBtn') Yes, remove

    // Set operational confirmation modal
  .modal.fade(id='operationalConfirmModal', tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content
        .modal-header
          h5.modal-title Confirm operational store
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body
          p#operationalConfirmMessage
            | Set this store as the operational store? Orders will consume stock from it.
          p.text-muted.small.mb-0
            | This will replace the current operational store.
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary(type='button', id='confirmSetOperationalBtn') Yes, set operational
        
  // Keep Stock page scripts inside #main-content so dashboard_nav AJAX loads them
  script(src='/javascripts/store_stock.js')
