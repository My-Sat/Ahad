extends ../layout

block content
  .d-none(data-main-width='wide')
  .d-flex.justify-content-between.align-items-center.mb-3
    h2.mb-0.text-white Messaging
    a.btn.btn-secondary(href='/admin/services') Back to services

  hr

  p.text-muted-light.small.mb-3
    | Manage automatic (dynamic) SMS for Order/Pay/Debtors events, and send custom/manual bulk SMS to customers.

  // Tabs
  ul.nav.nav-tabs.mb-3
    li.nav-item
      button.nav-link.active(type="button" data-bs-toggle="tab" data-bs-target="#tabAuto") Dynamic (Auto)
    li.nav-item
      button.nav-link(type="button" data-bs-toggle="tab" data-bs-target="#tabManual") Custom / Manual

  .tab-content
    // -------------------------
    // AUTO / DYNAMIC
    // -------------------------
    .tab-pane.fade.show.active#tabAuto
      // NEW: event select (Order / Pay / Debtors)
      .row.mb-3
        .col-12.col-lg-6
          label.form-label.text-muted-light(for="autoEventSelect") Auto event
          select.form-select.form-select-dark#autoEventSelect
            option(value="order" selected) Order (when order is placed)
            option(value="pay") Pay (when order is fully/partially paid)
            option(value="debtors") Debtors (periodic reminders)

      // -------------------------
      // ORDER AUTO SECTION
      // -------------------------
      #autoOrderSection
        .row.g-3
          .col-12.col-lg-6
            .card.dark-surface.border
              .card-body.dark-card-body
                h5.mb-2.text-white Auto Message Settings — Order
                p.text-muted-light.small.mb-3
                  | These messages are sent automatically after an order is placed.

                .form-check.form-switch.mb-2
                  input.form-check-input(type="checkbox" id="order_autoEnabled")
                  label.form-check-label.text-muted-light(for="order_autoEnabled")
                    | Enable auto SMS when an order is placed

                .form-check.form-switch.mb-3
                  input.form-check-input(type="checkbox" id="order_usePerType")
                  label.form-check-label.text-muted-light(for="order_usePerType")
                    | Use different template per customer type

                label.form-label.text-muted-light General template (fallback)
                textarea.form-control.form-control-dark#order_generalTemplate(
                  rows="4"
                  placeholder="Example: Thank you for doing business with AHADPRINT. You are currently a {category} customer..."
                )
                .text-muted-light.small.mt-2
                  | Placeholders: {name}, {category}, {phone}, {orderId}, {amount}, {totalBeforeDiscount}, {discountAmount}, {outstanding}, {accBalance}

                hr.text-muted-light

                .form-check.form-switch.mb-2
                  input.form-check-input(type="checkbox" id="order_appendSignature")
                  label.form-check-label.text-muted-light(for="order_appendSignature")
                    | Append signature/footer
                input.form-control.form-control-dark#order_signatureText(type="text" placeholder="AHADPRINT")

                button.btn.btn-primary.mt-3#order_saveAutoBtn(type="button")
                  i.bi.bi-save.me-1
                  | Save Auto Settings (Order)

          .col-12.col-lg-6
            .card.dark-surface.border
              .card-body.dark-card-body
                h5.mb-2.text-white Per Customer Type Templates — Order
                p.text-muted-light.small.mb-3
                  | Used only when “Use different template per customer type” is enabled.

                label.form-label.text-muted-light One-time
                textarea.form-control.form-control-dark#order_tplOneTime(rows="3")

                label.form-label.text-muted-light.mt-3 Regular
                textarea.form-control.form-control-dark#order_tplRegular(rows="3")

                label.form-label.text-muted-light.mt-3 Artist
                textarea.form-control.form-control-dark#order_tplArtist(rows="3")

                label.form-label.text-muted-light.mt-3 Organisation
                textarea.form-control.form-control-dark#order_tplOrganisation(rows="3")

      // -------------------------
      // PAY AUTO SECTION
      // -------------------------
      #autoPaySection(style="display:none;")
        .row.g-3
          .col-12.col-lg-6
            .card.dark-surface.border
              .card-body.dark-card-body
                h5.mb-2.text-white Auto Message Settings — Pay
                p.text-muted-light.small.mb-3
                  | These messages are sent automatically when an order becomes fully/partially paid.

                .form-check.form-switch.mb-2
                  input.form-check-input(type="checkbox" id="pay_autoEnabled")
                  label.form-check-label.text-muted-light(for="pay_autoEnabled")
                    | Enable auto SMS when an order is fully/partially paid

                .form-check.form-switch.mb-3
                  input.form-check-input(type="checkbox" id="pay_usePerType")
                  label.form-check-label.text-muted-light(for="pay_usePerType")
                    | Use different template per customer type

                label.form-label.text-muted-light General template (fallback)
                textarea.form-control.form-control-dark#pay_generalTemplate(
                  rows="4"
                  placeholder="Example: Thank you for your payment. You are currently a {category} customer..."
                )
                .text-muted-light.small.mt-2
                  | Placeholders: {name}, {category}, {phone}, {orderId}, {amount}, {totalBeforeDiscount}, {discountAmount}, {outstanding}, {accBalance}

                hr.text-muted-light

                .form-check.form-switch.mb-2
                  input.form-check-input(type="checkbox" id="pay_appendSignature")
                  label.form-check-label.text-muted-light(for="pay_appendSignature")
                    | Append signature/footer
                input.form-control.form-control-dark#pay_signatureText(type="text" placeholder="AHADPRINT")

                button.btn.btn-primary.mt-3#pay_saveAutoBtn(type="button")
                  i.bi.bi-save.me-1
                  | Save Auto Settings (Pay)

          .col-12.col-lg-6
            .card.dark-surface.border
              .card-body.dark-card-body
                h5.mb-2.text-white Per Customer Type Templates — Pay
                p.text-muted-light.small.mb-3
                  | Used only when “Use different template per customer type” is enabled.

                label.form-label.text-muted-light One-time
                textarea.form-control.form-control-dark#pay_tplOneTime(rows="3")

                label.form-label.text-muted-light.mt-3 Regular
                textarea.form-control.form-control-dark#pay_tplRegular(rows="3")

                label.form-label.text-muted-light.mt-3 Artist
                textarea.form-control.form-control-dark#pay_tplArtist(rows="3")

                label.form-label.text-muted-light.mt-3 Organisation
                textarea.form-control.form-control-dark#pay_tplOrganisation(rows="3")

      // -------------------------
      // DEBTORS AUTO SECTION
      // -------------------------
      #autoDebtorsSection(style="display:none;")
        .row.g-3
          .col-12.col-lg-6
            .card.dark-surface.border
              .card-body.dark-card-body
                h5.mb-2.text-white Auto Message Settings — Debtors
                p.text-muted-light.small.mb-3
                  | These messages are sent periodically to customers with outstanding balance.

                .form-check.form-switch.mb-2
                  input.form-check-input(type="checkbox" id="debtors_autoEnabled")
                  label.form-check-label.text-muted-light(for="debtors_autoEnabled")
                    | Enable periodic debtor reminders

                // Schedule
                label.form-label.text-muted-light.mt-2 Frequency
                select.form-select.form-select-dark#debtors_frequency
                  option(value="daily") Daily
                  option(value="weekly" selected) Weekly (Mondays)
                  option(value="monthly") Monthly (1st day)

                .row.g-2.mt-2
                  .col-6
                    label.form-label.text-muted-light Hour (0-23)
                    input.form-control.form-control-dark#debtors_hour(type="number" min="0" max="23" value="9")
                  .col-6
                    label.form-label.text-muted-light Minute (0-59)
                    input.form-control.form-control-dark#debtors_minute(type="number" min="0" max="59" value="0")

                .form-check.form-switch.mb-3.mt-3
                  input.form-check-input(type="checkbox" id="debtors_usePerType")
                  label.form-check-label.text-muted-light(for="debtors_usePerType")
                    | Use different template per customer type

                label.form-label.text-muted-light General template (fallback)
                textarea.form-control.form-control-dark#debtors_generalTemplate(
                  rows="4"
                  placeholder="Example: Hello {name}. You have an outstanding balance of GH₵ {outstanding}. Please visit to make payment."
                )
                .text-muted-light.small.mt-2
                  | Placeholders: {name}, {category}, {phone}, {outstanding}, {ordersCount}, {accBalance}

                hr.text-muted-light

                .form-check.form-switch.mb-2
                  input.form-check-input(type="checkbox" id="debtors_appendSignature")
                  label.form-check-label.text-muted-light(for="debtors_appendSignature")
                    | Append signature/footer
                input.form-control.form-control-dark#debtors_signatureText(type="text" placeholder="AHADPRINT")

                button.btn.btn-primary.mt-3#debtors_saveAutoBtn(type="button")
                  i.bi.bi-save.me-1
                  | Save Auto Settings (Debtors)

          .col-12.col-lg-6
            .card.dark-surface.border
              .card-body.dark-card-body
                h5.mb-2.text-white Per Customer Type Templates — Debtors
                p.text-muted-light.small.mb-3
                  | Used only when “Use different template per customer type” is enabled.

                label.form-label.text-muted-light One-time
                textarea.form-control.form-control-dark#debtors_tplOneTime(rows="3")

                label.form-label.text-muted-light.mt-3 Regular
                textarea.form-control.form-control-dark#debtors_tplRegular(rows="3")

                label.form-label.text-muted-light.mt-3 Artist
                textarea.form-control.form-control-dark#debtors_tplArtist(rows="3")

                label.form-label.text-muted-light.mt-3 Organisation
                textarea.form-control.form-control-dark#debtors_tplOrganisation(rows="3")

    // -------------------------
    // MANUAL
    // -------------------------
    .tab-pane.fade#tabManual
      .card.dark-surface.border
        .card-body.dark-card-body
          h5.mb-2.text-white Send Manual SMS
          p.text-muted-light.small.mb-3
            | Compose a message and choose recipients (all customers, by customer type, or debtors).

          .row.g-2
            .col-12.col-lg-8
              label.form-label.text-muted-light Message
              textarea.form-control.form-control-dark#manualMessage(
                rows="5"
                placeholder="Type your message here..."
              )

            .col-12.col-lg-4
              label.form-label.text-muted-light Send to
              select.form-select.form-select-dark#manualTarget
                option(value="all") All customers
                option(value="customer_type") By customer type
                option(value="debtors") Debtors (customers with outstanding balance)

              label.form-label.text-muted-light.mt-2#manualCustomerTypeLabel Customer type
              input.form-control.form-control-dark.mt-2#manualDebtorSearch(
                type="text"
                placeholder="Search debtors by name or phone..."
                disabled
              )
              select.form-select.form-select-dark#manualCustomerType(disabled)
                option(value="one_time") One-time
                option(value="regular") Regular
                option(value="artist") Artist
                option(value="organisation") Organisation

              button.btn.btn-success.mt-3.w-100#sendManualBtn(type="button")
                i.bi.bi-send.me-1
                | Send SMS

          .mt-3
            div.text-muted-light.small#manualResult

block append scripts
  // IMPORTANT: script is re-run after ajax navigation (dashboard_nav)
  script(src='/public/javascripts/messaging.js')
