extends ../layout

block content
  .container
    .row.justify-content-center
      .col-12.col-md-10
        .card.shadow-sm.dark-surface
          .card-body.dark-card-body
            .d-flex.justify-content-between.align-items-center.mb-3
              h4.mb-0.text-white Order Details
              .btn-group
                a.btn.btn-outline-secondary.btn-sm(href='/orders/new')
                  | Back to Orders

            // Order meta
            .mb-3
              if handler
                p.mb-1
                  strong Handled by:
                  |  #{handler.name || handler.username || handler._id}
              if customer
                p.mb-1
                  strong Customer:
                  |  #{customer.category === 'artist' ? (customer.businessName || customer.phone) : (customer.firstName || customer.businessName || customer.phone)}
              p.mb-1
                strong Order ID:
                |  #{order.orderId}
              p.mb-1
                strong Status:
                |  #{order.status}
              p.mb-1
                strong Created:
                |  #{order.createdAt ? new Date(order.createdAt).toLocaleString() : ''}
                
            // Items
            h6.mb-2.text-white Items
            if order.items && order.items.length
              .list-group.mb-3
                each it in order.items
                  - var rawLabel = it.selectionLabel || ''
                  - var subs = (rawLabel && rawLabel.length) ? rawLabel.split(/\s*\+\s*/).map(p => { const idx = p.indexOf(':'); return idx>=0 ? p.slice(idx+1).trim() : p.trim(); }).filter(Boolean).join(', ') : '(no label)';
                  .list-group-item.d-flex.justify-content-between.align-items-center
                    .me-2(style='min-width:0;flex:1;')
                      span(style='display:inline-block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:480px;') #{subs}
                      if it.fb
                        span.badge.bg-secondary.ms-2 F/B
                      if it.spoiled
                        span.text-danger.ms-2 Spoiled: #{it.spoiled}
                    .text-end(style='min-width:180px;')
                      - const rawPages = Number(it.pages || 1);
                      - const displayQty = (typeof it.effectiveQty !== 'undefined' && it.effectiveQty !== null) ? Number(it.effectiveQty) : (it.fb ? Math.ceil(rawPages / 2) : rawPages);
                      div QTY: #{displayQty}
                      div Unit: GH₵ #{(it.unitPrice||0).toFixed(2)}
                      // use the server-stored subtotal (do not recompute from raw pages)
                      div Subtotal: GH₵ #{(it.subtotal||0).toFixed(2)}

                      if it.printerName
                        div.small.text-muted-light Printer: #{it.printerName}

            else
              p.text-muted-light No items listed.

            // Totals + payments summary
            .d-flex.justify-content-end.mb-2
              .me-3
                div.text-white Total:
                strong GH₵ #{(order.total || 0).toFixed(2)}
              .me-3
                div.text-white Paid so far:
                strong GH₵ #{paidSoFar.toFixed(2)}
              .me-3
                div.text-white Remaining:
                if outstanding > 0
                  strong.text-danger GH₵ #{outstanding.toFixed(2)}
                else
                  strong.text-success GH₵ 0.00

            // Payment history
            h6.mb-2.text-white Payment History
            if order.payments && order.payments.length
              .table-responsive
                table.table.table-sm.table-striped
                  thead
                    tr
                      th Date
                      th Method
                      th.text-end Amount
                      th Details
                      th Note
                  tbody
                    each p in order.payments
                        - const dt = p.createdAt ? new Date(p.createdAt).toLocaleString() : ''
                        - const method = (p.method || 'unknown').toLowerCase()
                        - const amount = Number(p.amount || 0).toFixed(2)
                        - const meta = p.meta && typeof p.meta === 'object' ? p.meta : {}
                        - // known meta keys that we show explicitly
                        - const knownKeys = ['momoNumber','momoTxId','chequeNumber']
                        - // build extraMeta containing only keys not in knownKeys
                        - const extraMeta = {}
                        - Object.keys(meta || {}).forEach(function(k){ if (knownKeys.indexOf(k) === -1) extraMeta[k] = meta[k]; })

                        tr
                        td #{dt}
                        td #{method.toUpperCase()}
                        td.text-end GH₵ #{amount}
                        td
                            if method === 'momo'
                              if meta.momoNumber
                                div.mb-1
                                  small.text-muted-light Number:
                                  span.ms-2 #{meta.momoNumber}
                              if meta.momoTxId
                                div
                                  small.text-muted-light TxID:
                                  span.ms-2 #{meta.momoTxId}
                            else if method === 'cheque'
                              if meta.chequeNumber
                                div
                                  small.text-muted-light Cheque:
                                  span.ms-2 #{meta.chequeNumber}
                            // print any extra meta keys (only those not shown above)
                            if Object.keys(extraMeta).length
                              div.mt-1
                                each val, key in extraMeta
                                  div
                                    small.text-muted-light #{key}:
                                    span.ms-2 #{val}

                            // NEW: show who recorded this payment (if available)
                            if p.recordedBy && (typeof p.recordedBy === 'object') && (p.recordedBy.name || p.recordedBy.username)
                              div.mt-2
                                small.text-muted-light Recorded by:
                                span.ms-2 #{p.recordedBy.name || p.recordedBy.username}
                            else if p.recordedByName
                              div.mt-2
                                small.text-muted-light Recorded by:
                                span.ms-2 #{p.recordedByName}

                        td #{p.note || ''}
            else
              p.text-muted-light No payments recorded.

            // Actions (record payment -> jumps to /orders/pay with id)
            .d-flex.justify-content-end.mt-3
