extends ../layout

block content
  .container#ordersNewPage(data-is-admin=(currentUser && currentUser.role && String(currentUser.role).toLowerCase() === 'admin') ? 'true' : 'false')
    .d-none(data-main-width='wide')
    .row.justify-content-center
      .col-12.col-md-12
        .card.shadow-sm.dark-surface
          .card-body.dark-card-body
            // Title row: Job Order + Orders explorer button
            .d-flex.justify-content-between.align-items-center.mb-3
              h4.mb-0.text-white Job Order
              // Orders button (existing)
              .mb-2
                button.btn.btn-outline-light-custom.btn-sm#openOrdersExplorerBtn(type='button', title='View orders')
                  i.bi.bi-list-check.me-1
                  | Orders

            if customer
              input(type='hidden', id='orderCustomerId', value=customer._id)

            // Selected customer at top (centered)
            - const hasCustomer = !!customer;
            .card.mb-3.dark-surface#selectedCustomerCard(style='border:1px solid rgba(255,255,255,.08);' + (hasCustomer ? '' : 'display:none;'))
              .card-body.dark-card-body.py-2.text-center
                div.small.text-muted-light.mb-1 Selected customer
                if customer && (customer.category === 'artist' || customer.category === 'organisation')
                  strong#selectedCustomerName(style='color:#21BCFF;') #{customer.businessName || customer.phone}
                else if customer
                  strong#selectedCustomerName(style='color:#21BCFF;') #{customer.firstName || customer.businessName || customer.phone}
                else
                  strong#selectedCustomerName(style='color:#21BCFF;')

                // phone
                if customer
                  strong#selectedCustomerPhone.text-muted-light.ms-3 #{customer.phone}
                else
                  strong#selectedCustomerPhone.text-muted-light.ms-3

                // customer type (same visual weight)
                -
                  const categoryLabel =
                    (customer && customer.category === 'artist')
                      ? 'Artist'
                      : (customer && customer.category === 'organisation')
                        ? 'Organisation'
                        : (customer && customer.category === 'regular')
                          ? 'Regular'
                          : 'One-Time';
                if customer
                  strong#selectedCustomerCategory.text-muted-light.ms-3 #{categoryLabel}
                else
                  strong#selectedCustomerCategory.text-muted-light.ms-3
                .mt-2
                  button.btn.btn-sm.btn-outline-light-custom#clearCustomerBtn(type='button') Clear attached customer

            // Customer lookup + registration (moved from customers/front)
            .card.mb-3.dark-surface#customer-lookup(style='border:1px solid rgba(255,255,255,.08);')
              .card-body.dark-card-body.py-2
                .d-flex.justify-content-between.align-items-center.mb-2
                  h6.mb-0.text-white Customer Lookup
                  if customer
                    span.small.text-muted-light Attached

                form#customerLookupForm.row.g-2(role='form')
                  .col-12.col-md-6
                    input#lookupPhone.form-control.form-control-dark(
                      type='text',
                      placeholder='Type phone or name',
                      aria-label='Phone or name'
                    )
                  .col-auto
                    button.btn.btn-primary#lookupBtn(type='submit') Lookup
                  .col-auto
                    button.btn.btn-outline-secondary#registerBtn(type='button') Register Customer

                small.text-muted-light.d-block.mt-2
                  | Type a phone or name to search. Select a suggestion to attach to this order.

            // selection row (service category + services + books)
            .row.g-2.mb-3
              .col-md-4
                label.form-label(for='serviceCategorySelect') Service Category
                select.form-select.form-select-dark(id='serviceCategorySelect', aria-label='Service Category')
                  // placeholder — selected but disabled so user must explicitly choose a category
                  option(value='' disabled selected hidden) -- Select a category --
                  // categories will be populated by client JS
              .col-md-4
                label.form-label(for='serviceSelect') Service
                select.form-select.form-select-dark(id='serviceSelect')
                  option(value='') -- Select a service --
                  each s in services
                    // keep server-provided services for backward compatibility; prices will be loaded client-side
                    option(value=s._id)= s.name
              .col-md-3.d-flex.align-items-end

            // price rules list (populated via AJAX or when a book is selected)
            .card.mt-3.dark-surface
              .card-body.dark-card-body
                h6.mb-2.text-white Price rules for selected service / book
                p.text-muted-light.small Select a rule and enter number of pages/qty (if applicable) then click Apply to add to cart.
                #pricesList
                  p.text-muted-light Select a service to load price rules.

          // Cart / Order summary
          .card.mt-3.dark-surface
            .card-body.dark-card-body
              .d-flex.justify-content-between.align-items-center.mb-2
                h6.mb-0.text-white Cart

                // ADMIN-ONLY: Manual discount (per order, not saved)
                if currentUser && currentUser.role && String(currentUser.role).toLowerCase() === 'admin'
                  span.badge.bg-info Manual discount

              // ADMIN-ONLY: manual discount UI (applies AFTER items are in cart)
              // NOTE: This block now contains ONLY the inputs/buttons.
              // The discount breakdown (#manualDiscountSummary) is rendered under Cart totals instead.
              if currentUser && currentUser.role && String(currentUser.role).toLowerCase() === 'admin'
                .card.mb-3.dark-surface(style='border:1px solid rgba(255,255,255,.08);')
                  .card-body.dark-card-body.py-2
                    .row.g-2.align-items-end
                      .col-12.col-md-3
                        label.form-label.mb-1(for='manualDiscountMode') Discount mode
                        select.form-select.form-select-sm.form-select-dark#manualDiscountMode
                          option(value='amount') Amount (GH₵)
                          option(value='percent') Percent (%)
                      .col-12.col-md-3
                        label.form-label.mb-1(for='manualDiscountValue') Value
                        input.form-control.form-control-sm.form-control-dark#manualDiscountValue(type='number', min='0', step='0.01', placeholder='e.g. 5 or 10')
                      .col-12.col-md-6.d-flex.gap-2.justify-content-end
                        button.btn.btn-sm.btn-outline-light-custom#applyManualDiscountBtn(type='button') Apply Discount
                        button.btn.btn-sm.btn-outline-light-custom#clearManualDiscountBtn(type='button', style='display:none;') Clear

                    p.text-muted-light.small.mt-2.mb-0
                      | This discount applies only to this order and will not be saved. You must re-apply it for each order when needed.

              .table-responsive
                table.table.table-sm.table-borderless#cartTable
                  thead
                    tr
                      th Selection
                      th.text-center Pages
                      th.text-center QTY
                      th.text-center Sheets
                      th.text-end Unit
                      th.text-end Subtotal
                      th.text-center Actions
                  tbody#cartTbody
                    tr
                      td.text-muted-light(colspan='5') Cart is empty.


                // ✅ ADMIN-ONLY: discount breakdown rendered under cart totals (only shown when discount is applied)
                if currentUser && currentUser.role && String(currentUser.role).toLowerCase() === 'admin'
                  .mt-2#manualDiscountSummary(style='display:none;')
                    .d-flex.justify-content-end
                      .text-end
                        div.small.text-muted-light Total before discount:
                        strong#manualDiscountTotalBefore.text-white GH₵ 0.00
                    .d-flex.justify-content-end
                      .text-end
                        div.small.text-muted-light Discount:
                        strong#manualDiscountAmount.text-white - GH₵ 0.00
                .d-flex.justify-content-end.mt-2

                  span.me-3.fs-5.text-white Total:
                  strong.fs-5#cartTotal.text-white GH₵ 0.00        


                .d-flex.justify-content-end.mt-3.gap-2
                  button.btn.btn-outline-light-custom#saveDraftBtn(type='button', disabled) Save Draft
                  button.btn.btn-primary#orderNowBtn(type='button', disabled) Order Now

    // small debug area
    .mt-3.text-muted-light.small
      | After placing the order you will receive an Order ID to use at payment.

  // Orders Explorer Modal (rich UI, date filters, table) - unchanged...
  .modal.fade(id='ordersExplorerModal', tabindex='-1', aria-labelledby='ordersExplorerModalLabel', aria-hidden='true')
    .modal-dialog.modal-xl.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='ordersExplorerModalLabel') Orders Explorer
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          .row.g-2.mb-3.align-items-center
            .col-auto
              label.form-label.mb-0 small.text-muted-light Small Date Range
            .col-auto
              input.form-control.form-control-dark(type='date', id='ordersFrom')
            .col-auto
              input.form-control.form-control-dark(type='date', id='ordersTo')
            .col
              .btn-group
                button.btn.btn-outline-light-custom.btn-sm#presetToday(type='button') Today
                button.btn.btn-outline-light-custom.btn-sm#presetYesterday(type='button') Yesterday
                button.btn.btn-outline-light-custom.btn-sm#presetThisWeek(type='button') This Week
              button.btn.btn-primary.btn-sm.ms-2#fetchOrdersBtn(type='button') Refresh
            .col-auto.text-end
              small.text-muted-light#ordersCount -- results

          // search / table
          .table-responsive
            table.table.table-hover.table-sm#ordersTable
              thead
                tr
                  th Name
                  th.text-end Total
                  th Status
                  th Created
                  th.text-center Actions
              tbody
                tr
                  td.text-muted-light(colspan='5') Use the date filters above and click Refresh to load orders.

        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Close

  // Registration modal (customer / artist)
  .modal.fade(id='registerCustomerModal', tabindex='-1', aria-labelledby='registerCustomerModalLabel', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='registerCustomerModalLabel').text-white Register Customer
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          form#registerCustomerForm
            .mb-2
              label.form-label(for='regCategory') Register as
              select.form-select#regCategory
                option(value='one_time') Customer
                option(value='artist') Artist
                option(value='organisation') Organisation / NGO
            .mb-2#regFirstNameGroup
              label.form-label(for='regFirstName') Full Name
              input.form-control.form-control-dark#regFirstName(type='text', placeholder='Full name')
            .mb-2#regBusinessNameGroup(style='display:none;')
              label.form-label(for='regBusinessName') Business name
              input.form-control.form-control-dark#regBusinessName(type='text', placeholder='Business name')
            .mb-2
              label.form-label(for='regPhone') Phone
              input.form-control.form-control-dark#regPhone(type='text', placeholder='Phone number')
            .mb-2
              label.form-label(for='regNotes') Notes (optional)
              input.form-control.form-control-dark#regNotes(type='text', placeholder='Notes')
              input(type='hidden', id='regCustomerId')
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary#saveCustomerBtn(type='button') Register

  // Keep Orders New scripts inside #main-content so dashboard_nav AJAX loads them
  script(defer src='/javascripts/customer_editor.js')
  script(defer src='/javascripts/customers_front.js')
