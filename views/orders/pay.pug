extends ../layout

block content
  .container
    .row.justify-content-center
      .col-md-12
        .card.shadow-sm.dark-surface
          .card-body.dark-card-body
            // My cashier summary (visible to cashier when logged in)
            .mb-3#myCashierStatusContainer(style='display:none;')
              .card.border-1.dark-surface
                .card-body.p-2.dark-card-body
                  .d-flex.justify-content-between.align-items-center
                    .me-3
                      div.small.text-muted-light Cashier summary (today)
                      div#myCashierName.small
                    .text-end
                      div.small.text-muted-light Today's cash:
                      strong#myCashToday GH₵ 0.00
                    .text-end.ms-3
                      div.small.text-muted-light Previous balance:
                      strong#myPrevBalance GH₵ 0.00


            .d-flex.justify-content-between.align-items-center.mb-3
              h4.mb-0.text-white Pay Order
              .d-flex.gap-2
                // Orders (existing style) kept for parity with job order page
                button.btn.btn-outline-light-custom.btn-sm#openOrdersExplorerBtn(type='button', title='View orders')
                  i.bi.bi-list-check.me-1
                  | Orders
                // Debtors button (new)
                button.btn.btn-outline-light-custom.btn-sm#openDebtorsBtn(type='button', title='Debtors')
                  i.bi.bi-list-check.me-1
                  | Debtors
                  
                // Cashiers / Collections (new) & Accountant — show only to admins
                if currentUser && currentUser.role && currentUser.role.toLowerCase() === 'admin'
                  button.btn.btn-outline-light-custom.btn-sm#openCashiersBtn(type='button', title='Cashiers')
                    i.bi.bi-people.me-1
                    | Receive Payments
                if currentUser && currentUser.role && currentUser.role.toLowerCase() === 'admin'
                  button.btn.btn-outline-light-custom.btn-sm#openCustomersBtn(type='button', title='Customers')
                    i.bi.bi-people.me-1
                    | Customers
                if currentUser && currentUser.role && currentUser.role.toLowerCase() === 'admin'
                  a.btn.btn-outline-light-custom.btn-sm(href='/admin/discounts', title='Discounts')
                    i.bi.bi-percent.me-1
                    | Discount
    

                  button.btn.btn-outline-light-custom.btn-sm#openAccountantBtn(type='button', title='Accountant ledger')
                    i.bi.bi-journal-check.me-1
                    | Accountant



            p.text-muted-light Enter the Order ID to fetch the amount due and mark it as paid.

            form#fetchOrderForm(class='row g-2 mb-3', novalidate)
              .col
                input.form-control.form-control-dark(type='text', id='fetchOrderId', placeholder='Order ID', required)
              .col-auto
                button.btn.btn-primary(type='submit', id='fetchOrderBtn') Fetch

            // result
            .card.mt-3.dark-surface
              .card-body.dark-card-body
                #orderInfo
                  p.text-muted-light No order loaded.

                // Payment controls (appear after order is fetched)
                .mt-3#paymentControls(style='display:none;')
                  // inside .mt-3#paymentControls (before Payment method selector is fine)
                  #customerAccountControls.mb-3(style='display:none;')
                    .d-flex.justify-content-between.align-items-center
                      div
                        div.small.text-muted-light Customer Account Balance:
                        strong#customerAccountBalance GH₵ 0.00
                      button.btn.btn-outline-light-custom.btn-sm#payFromAccountBtn(type='button')
                        i.bi.bi-wallet2.me-1
                        | Pay from account
                    div.small.text-muted-light.mt-1
                      | Uses available balance to reduce outstanding before payment.

                  // Payment method selector
                  .mb-2
                    label.form-label.mb-1(for='paymentMethod') Payment method
                    select.form-select.form-select-sm.form-select-dark#paymentMethod
                      option(value='cash') Cash
                      option(value='momo') MoMo
                      option(value='cheque') Cheque

                  // MoMo fields
                  .row.g-2.mb-2#paymentMomoFields(style='display:none;')
                    .col-6
                      label.form-label.mb-0(for='momoNumber') MoMo Number
                      input.form-control.form-control-sm.form-control-dark(type='text', id='momoNumber', placeholder='e.g. 054xxxxxxxx')
                    .col-6
                      label.form-label.mb-0(for='momoTxId') Transaction ID
                      input.form-control.form-control-sm.form-control-dark(type='text', id='momoTxId', placeholder='MoMo transaction id')

                  // Cheque field
                  .mb-2#paymentChequeField(style='display:none;')
                    label.form-label.mb-0(for='chequeNumber') Cheque number
                    input.form-control.form-control-sm.form-control-dark(type='text', id='chequeNumber', placeholder='Cheque number')

                  // Part payment toggle and amount
                  .form-check.mb-2
                    input.form-check-input(type='checkbox', id='partPaymentToggle')
                    label.form-check-label(for='partPaymentToggle') Manual amount (Part payment / Overpay)
                  .mb-2#partPaymentAmountWrapper(style='display:none;')
                    label.form-label.mb-0(for='partPaymentAmount') Enter amount to pay now (GH₵)
                    input.form-control.form-control-sm.form-control-dark(type='number', id='partPaymentAmount', min='0.01', step='0.01', placeholder='Amount')

                .d-flex.justify-content-end.mt-3
                  button.btn.btn-success#payNowBtn(type='button', disabled) Pay Now
  // Cashiers modal (accountant view)
  .modal.fade(id='cashiersModal', tabindex='-1', aria-labelledby='cashiersModalLabel', aria-hidden='true')
    .modal-dialog.modal-lg.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='cashiersModalLabel') Cashiers — Daily collections
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          p.text-muted.small#cashiersStatusLoading Loading...
          .table-responsive
            table.table.table-sm.table-hover#cashiersTable
              thead
                tr
                  th Cashier
                  th.text-end Today's Payments
                  th.text-end Already Collected
                  th.text-end Previous Balance
                  th.text-center Actions
              tbody
                tr
                  td.text-muted(colspan='6') Loading...
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Close
  // Accountant ledger modal
  .modal.fade(id='accountantModal', tabindex='-1', aria-labelledby='accountantModalLabel', aria-hidden='true')
    .modal-dialog.modal-lg.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='accountantModalLabel') Accountant — Daily ledger
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          p.text-muted.small#accountantLedgerDate Loading...
          .table-responsive
            table.table.table-sm.table-hover#accountantLedgerTable
              thead
                tr
                  th Accountant
                  th.text-end Total collected (GH₵)
                  th.text-center Actions
              tbody
                tr
                  td.text-muted(colspan='3') Loading...
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Close

          // Customers Explorer Modal
  .modal.fade(id='customersModal', tabindex='-1', aria-labelledby='customersModalLabel', aria-hidden='true')
    .modal-dialog.modal-xl.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title#customersModalLabel Customers
          button.btn-close(type='button', data-bs-dismiss='modal')

        .modal-body.dark-card-body
          p.text-muted.small#customersCount Loading...

                    // Search (filters by phone/name)
          .mb-2
            .input-group.input-group-sm
              span.input-group-text.bg-transparent.text-muted-light
                i.bi.bi-search
              input.form-control.form-control-sm.form-control-dark#customersSearchInput(
                type='text',
                placeholder='Search by name or phone...',
                autocomplete='off'
              )
              button.btn.btn-outline-light-custom#customersSearchClearBtn(type='button') Clear
            .small.text-muted-light.mt-1 Type to filter customers by phone or name.


          .table-responsive
            table.table.table-hover.table-sm#customersTable
              thead
                tr
                  th Name
                  th Phone
                  th Category
                  th Registered
                  th.text-center Actions
              tbody
                tr
                  td.text-muted(colspan='5') Loading customers...

        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Close

            // Registration modal (customer / artist)
  .modal.fade(id='registerCustomerModal', tabindex='-1', aria-labelledby='registerCustomerModalLabel', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='registerCustomerModalLabel').text-white Register Customer
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          form#registerCustomerForm
            .mb-2
              label.form-label(for='regCategory') Register as
              select.form-select#regCategory
                option(value='one_time') Customer
                option(value='artist') Artist
                option(value='organisation') Organisation / NGO
            .mb-2#regFirstNameGroup
              label.form-label(for='regFirstName') Full Name
              input.form-control.form-control-dark#regFirstName(type='text', placeholder='Full name')
            .mb-2#regBusinessNameGroup(style='display:none;')
              label.form-label(for='regBusinessName') Business name
              input.form-control.form-control-dark#regBusinessName(type='text', placeholder='Business name')
            .mb-2
              label.form-label(for='regPhone') Phone
              input.form-control.form-control-dark#regPhone(type='text', placeholder='Phone number')
            .mb-2
              label.form-label(for='regNotes') Notes (optional)
              input.form-control.form-control-dark#regNotes(type='text', placeholder='Notes')
              input(type='hidden', id='regCustomerId')
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-primary#saveCustomerBtn(type='button') Register

          


  // Debtors modal (lists part-payment transactions; client fetches /debtors)
  .modal.fade(id='debtorsModal', tabindex='-1', aria-labelledby='debtorsModalLabel', aria-hidden='true')
    .modal-dialog.modal-lg.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='debtorsModalLabel') Debtors / Part-payments
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          p.text-muted.small#debtorsCount Loading...
                    // Search (filters by debtor/order id/phone)
          .mb-2
            .input-group.input-group-sm
              span.input-group-text.bg-transparent.text-muted-light
                i.bi.bi-search
              input.form-control.form-control-sm.form-control-dark#debtorsSearchInput(
                type='text',
                placeholder='Search by debtor name / order id / phone...',
                autocomplete='off'
              )
              button.btn.btn-outline-light-custom#debtorsSearchClearBtn(type='button') Clear
            .small.text-muted-light.mt-1 Type to filter debtors as you type.

          .table-responsive
            table.table.table-sm.table-hover#debtorsTable
              thead
                tr
                  th Order ID
                  th Debtor
                  th.text-end Amount Due
                  th.text-end Paid So Far
                  th.text-end Outstanding
                  th.text-center Actions
              tbody
                tr
                  td.text-muted(colspan='6') Loading...
        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Close

          // Full Payment Confirmation Modal
  .modal.fade#fullPaymentConfirmModal(tabindex='-1', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title Confirm Full Payment
          button.btn-close(type='button', data-bs-dismiss='modal')

        .modal-body.dark-card-body
          p#fullPaymentConfirmText.mb-3

          .mb-2
            label.form-label.mb-1 Payment method
            select.form-select.form-select-sm.form-select-dark#fullPaymentMethod
              option(value='cash') Cash
              option(value='momo') MoMo
              option(value='cheque') Cheque

          .row.g-2.mb-2#fullPaymentMomoFields(style='display:none;')
            .col-6
              label.form-label.mb-0 MoMo Number
              input.form-control.form-control-sm.form-control-dark#fullPaymentMomoNumber(type='text')
            .col-6
              label.form-label.mb-0 Transaction ID
              input.form-control.form-control-sm.form-control-dark#fullPaymentMomoTx(type='text')

          .mb-2#fullPaymentChequeField(style='display:none;')
            label.form-label.mb-0 Cheque Number
            input.form-control.form-control-sm.form-control-dark#fullPaymentCheque(type='text')

        .modal-footer
          button.btn.btn-outline-light-custom(type='button', data-bs-dismiss='modal') Cancel
          button.btn.btn-success#confirmFullPaymentBtn Confirm Payment


  // Orders Explorer Modal (same UX as new.pug)
  .modal.fade(id='ordersExplorerModal', tabindex='-1', aria-labelledby='ordersExplorerModalLabel', aria-hidden='true')
    .modal-dialog.modal-xl.modal-dialog-centered
      .modal-content.dark-surface
        .modal-header
          h5.modal-title(id='ordersExplorerModalLabel') Orders Explorer
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        .modal-body.dark-card-body
          .row.g-2.mb-3.align-items-center
            .col-auto
              label.form-label.mb-0 small.text-muted-light Small Date Range
            .col-auto
              input.form-control.form-control-dark(type='date', id='ordersFrom')
            .col-auto
              input.form-control.form-control-dark(type='date', id='ordersTo')
            .col
              .btn-group
                button.btn.btn-outline-light-custom.btn-sm#ordersPresetToday(type='button') Today
                button.btn.btn-outline-light-custom.btn-sm#ordersPresetYesterday(type='button') Yesterday
                button.btn.btn-outline-light-custom.btn-sm#ordersPresetThisWeek(type='button') This Week
              button.btn.btn-primary.btn-sm.ms-2#ordersFetchBtn(type='button') Refresh
            .col-auto.text-end
              small.text-muted-light#ordersCount -- results

          // orders table
          .table-responsive
            table.table.table-hover.table-sm#ordersModalTable
              thead
                tr
                  th Name
                  th.text-end Total
                  th Status
                  th Created
                  th.text-center Actions
              tbody
                tr
                  td.text-muted(colspan='5') Use the date filters above and click Refresh to load orders.

        .modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Close

block append scripts
  script(src='/javascripts/customer_editor.js')
  script(src='/javascripts/customers_front.js')
  script(src='/javascripts/orders_pay.js')
